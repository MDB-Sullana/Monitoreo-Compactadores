<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Monitoreo Ciudadano - Bellavista</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet (Mapa PRO) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- EmailJS v4 -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script>
    emailjs.init({ publicKey: "IGGKWnrPTdwnN39yS" });
  </script>

  <style>
    body { font-family: 'Inter', sans-serif; background: #f3f4f6; }

    /* BOTÃ“N FLOTANTE */
    #chatbot-button {
      position: fixed;
      bottom: 25px;
      right: 25px;
      background: #1e3a8a;
      color: white;
      width: 65px;
      height: 65px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      cursor: pointer;
      box-shadow: 0 6px 15px rgba(0,0,0,0.3);
      z-index: 9999;
    }

    /* VENTANA DEL CHAT */
    #chatbot-window {
      width: 330px;
      height: 480px;
      background: white;
      position: fixed;
      bottom: 100px;
      right: 25px;
      border-radius: 15px;
      box-shadow: 0 0 20px rgba(0,0,0,0.25);
      display: none;
      flex-direction: column;
      overflow: hidden;
      z-index: 9999;
    }

    #chatbot-messages {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      background: #e5e7eb;
    }

    .msg {
      margin-bottom: 10px;
      padding: 10px 14px;
      max-width: 80%;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.3;
    }

    .bot { background: white; color: black; }
    .user { background: #1e3a8a; color: white; margin-left: auto; }

    /* INPUT DE TEXTO */
    #chat-input-box {
      display: flex;
      padding: 8px;
      border-top: 1px solid #ddd;
      background: white;
    }

    #user-input {
      flex: 1;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 8px;
    }

    #send-btn {
      margin-left: 6px;
      background: #1e3a8a;
      color: white;
      padding: 8px 14px;
      border-radius: 8px;
      cursor: pointer;
    }

    /* ANIMACIONES PRO */
    @keyframes fadeIn { 0% { opacity: 0; transform: scale(0.95); } 100% { opacity: 1; transform: scale(1); } }
    @keyframes slideUp { 0% { opacity: 0; transform: translateY(25px); } 100% { opacity: 1; transform: translateY(0); } }
    @keyframes pulse { 0%, 100% { transform: scale(1); filter: brightness(1); } 50% { transform: scale(1.06); filter: brightness(1.15); } }
    @keyframes slide { 0% { transform: translateX(-30px); opacity: 0.3; } 50% { transform: translateX(30px); opacity: 1; } 100% { transform: translateX(-30px); opacity: 0.3; } }
    @keyframes glow { 0% { box-shadow: 0 0 0px 0px rgba(255,255,255,0.0); } 50% { box-shadow: 0 0 20px 5px rgba(255,255,255,0.35); } 100% { box-shadow: 0 0 0px 0px rgba(255,255,255,0.0); } }

    /* MAPA */
    #leaflet-map { width: 100%; height: 80vh; border-radius: 16px; overflow: hidden; }
    .leaflet-control-layers { border-radius: 12px !important; }

    /* Overlay Cochera */
    #cochera-overlay {
      position: absolute;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 500; /* encima del mapa */
    }
    #cochera-overlay .glass {
      width: 100%;
      max-width: 1100px;
      border-radius: 24px;
      padding: 28px;
      background: rgba(10, 30, 80, 0.55);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.18);
      box-shadow: 0 18px 40px rgba(0,0,0,0.35);
      animation: fadeIn 0.6s ease-out;
      color: white;
    }
    #status-pill {
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: rgba(15, 23, 42, 0.75);
      color: white;
    }
    .dot {
      width: 8px; height: 8px; border-radius: 999px;
      display: inline-block;
      background: #22c55e;
      box-shadow: 0 0 10px rgba(34,197,94,0.65);
    }
    .dot-off { background: #f59e0b; box-shadow: 0 0 10px rgba(245,158,11,0.65); }

  </style>
</head>

<body>

<!-- HEADER PRO -->
<header class="relative shadow-xl py-3 px-4 flex items-center justify-center">
  <div class="absolute inset-0 bg-gradient-to-r from-blue-900 via-blue-800 to-blue-900 opacity-95"></div>

  <div class="relative z-10 flex items-center gap-4 select-none">
    <div class="relative">
      <img
        src="./logo-bellavista.jpeg"
        onerror="this.src='https://placehold.co/100x100/1e3a8a/ffffff?text=LOGO'"
        class="h-14 w-14 md:h-16 md:w-16 rounded-full object-cover shadow-xl
               ring-2 ring-white/40 animate-[pulse_4s_ease-in-out_infinite]"
      >
      <div class="absolute inset-0 rounded-full animate-[glow_3s_infinite]"></div>
    </div>

    <div class="flex flex-col justify-center text-white">
      <span class="text-xs md:text-sm uppercase tracking-wide text-blue-200 font-semibold">
        Municipalidad Distrital de Bellavista
      </span>
      <h1 class="text-lg md:text-2xl font-extrabold leading-tight drop-shadow-lg">
        Monitoreo Ciudadano de Camiones Compactadores
      </h1>
      <div class="mt-1 h-1 w-24 bg-gradient-to-r from-blue-300 to-white rounded-full"></div>
    </div>
  </div>
</header>

<!-- CONTENIDO PRINCIPAL -->
<main class="p-4">
  <!-- Barra superior del mapa -->
  <div class="mb-3 flex flex-wrap items-center justify-between gap-3">
    <div class="flex items-center gap-3">
      <span id="status-pill">
        <span id="live-dot" class="dot"></span>
        <span id="live-text">En vivo (actualizando)</span>
      </span>

      <span class="text-xs text-slate-500">
        Mapa satelital con calles. Puedes cambiar capas en el control del mapa.
      </span>
    </div>

    <div class="text-xs text-slate-600">
      Horario mapa: <b>05:00 â€“ 23:59</b> | Cochera: <b>00:00 â€“ 04:59</b>
    </div>
  </div>

  <!-- Contenedor mapa + overlay cochera -->
  <div class="relative">
    <div id="leaflet-map" class="shadow-xl"></div>

    <!-- Overlay cochera (aparece 00:00â€“04:59 pero el mapa y camiones siguen debajo) -->
    <div id="cochera-overlay">
      <div class="glass">
        <div class="flex flex-col md:flex-row items-center gap-8">
          <div class="flex flex-col items-center">
            <img
              src="./logo-bellavista.jpeg"
              onerror="this.src='https://placehold.co/200x200/1e3a8a/ffffff?text=LOGO';"
              class="w-28 h-28 md:w-36 md:h-36 rounded-full shadow-xl object-cover animate-[pulse_3s_infinite] ring-4 ring-white/30"
            >
            <div class="mt-3 w-20 h-1 bg-gradient-to-r from-blue-300 to-white rounded-full animate-[slide_2s_infinite]"></div>
          </div>

          <div class="text-center md:text-left animate-[slideUp_0.7s_ease-out]">
            <h2 class="text-2xl md:text-3xl font-extrabold leading-tight drop-shadow-lg">
              UNIDADES EN COCHERA
              <span class="block text-blue-200">Monitoreo nocturno (00:00 â€“ 04:59)</span>
            </h2>
            <p class="mt-3 text-blue-100">
              Los camiones permanecen visibles en el mapa. La transmisiÃ³n en vivo continÃºa.
            </p>
            <p class="mt-2 text-blue-200 text-sm">
              Si no ves movimiento, es normal: podrÃ­an estar detenidos o sin recorrido reciente.
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- BOTÃ“N FLOTANTE -->
<div id="chatbot-button">ðŸ’¬</div>

<!-- CHATBOT -->
<div id="chatbot-window">
  <div id="chatbot-messages"></div>
  <div id="chat-input-box">
    <input type="text" id="user-input" placeholder="Escribe aquÃ­...">
    <button id="send-btn">Enviar</button>
  </div>
</div>

<script>
  // =========================
  // CONFIG
  // =========================
  const WORKER_URL = "https://gps-bellavista.karolmauricio12.workers.dev/"; // tu worker
  const REFRESH_MS = 5000;

  // IDs confirmados
  const DEVICE_1 = { id: 305, name: "COMPACTADOR" };
  const DEVICE_2 = { id: 809, name: "COMPACTADOR 2" };

  // =========================
  // MAPA (Leaflet PRO)
  // =========================
  let map;
  let layers = {};
  let markers = {};
  let polylines = {};
  let lastUpdateOk = false;

  function initMap() {
    // Base: SatÃ©lite (Esri) + etiquetas (Esri overlay) => estilo tipo Google (con calles/nombres)
    const esriImagery = L.tileLayer(
      "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
      { maxZoom: 20, attribution: "Tiles Â© Esri" }
    );

    const esriLabels = L.tileLayer(
      "https://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}",
      { maxZoom: 20, attribution: "Labels Â© Esri" }
    );

    // Alternativas (selector de capas)
    const osmStreets = L.tileLayer(
      "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
      { maxZoom: 19, attribution: "Â© OpenStreetMap" }
    );

    const topo = L.tileLayer(
      "https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png",
      { maxZoom: 17, attribution: "Â© OpenTopoMap, Â© OpenStreetMap" }
    );

    map = L.map("leaflet-map", {
      zoomControl: true,
      preferCanvas: true,
      layers: [esriImagery, esriLabels] // predeterminado: satÃ©lite + nombres
    }).setView([-4.8845, -80.6778], 14);

    // Base layers (para elegir)
    const baseLayers = {
      "SatÃ©lite (predeterminado)": esriImagery,
      "Calles (OSM)": osmStreets,
      "TopogrÃ¡fico": topo
    };

    // Overlays
    const overlayLayers = {
      "Nombres / Etiquetas": esriLabels
    };

    L.control.layers(baseLayers, overlayLayers, { collapsed: false }).addTo(map);

    // Preparar elementos por camiÃ³n
    markers[DEVICE_1.id] = L.circleMarker([-4.8845, -80.6778], { radius: 9, weight: 2, fillOpacity: 0.9 }).addTo(map).bindPopup(DEVICE_1.name);
    markers[DEVICE_2.id] = L.circleMarker([-4.8842, -80.6777], { radius: 9, weight: 2, fillOpacity: 0.9 }).addTo(map).bindPopup(DEVICE_2.name);

    polylines[DEVICE_1.id] = L.polyline([], { color: "#FFD400", weight: 5, opacity: 0.9 }).addTo(map);
    polylines[DEVICE_2.id] = L.polyline([], { color: "#FFD400", weight: 5, opacity: 0.9 }).addTo(map);
  }

  function setMarkerStyle(id, speed) {
    // Verde si se mueve, Amarillo si detenido
    const moving = (Number(speed) || 0) > 0;
    const stroke = moving ? "#16a34a" : "#f59e0b";
    const fill = moving ? "#22c55e" : "#fbbf24";
    markers[id].setStyle({ color: stroke, fillColor: fill });
  }

  function normalizeTail(tail) {
    // tail puede venir como: [[lat,lng], ...] o [{lat:"",lng:""}, ...]
    if (!Array.isArray(tail)) return [];
    const out = [];
    for (const p of tail) {
      if (Array.isArray(p) && p.length >= 2) {
        const lat = Number(p[0]), lng = Number(p[1]);
        if (!Number.isNaN(lat) && !Number.isNaN(lng)) out.push([lat, lng]);
      } else if (p && typeof p === "object" && "lat" in p && "lng" in p) {
        const lat = Number(p.lat), lng = Number(p.lng);
        if (!Number.isNaN(lat) && !Number.isNaN(lng)) out.push([lat, lng]);
      }
    }
    return out;
  }

  function applyDevice(item) {
    if (!item || typeof item !== "object") return;

    const id = Number(item.id);
    const lat = Number(item.lat);
    const lng = Number(item.lng);

    if (!markers[id] || Number.isNaN(lat) || Number.isNaN(lng)) return;

    markers[id].setLatLng([lat, lng]);
    setMarkerStyle(id, item.speed);

    // LÃ­nea amarilla: usamos tail + punto actual
    const tailPts = normalizeTail(item.tail);
    const pts = tailPts.length ? tailPts : [];
    // asegurar incluir punto actual al final
    pts.push([lat, lng]);

    polylines[id].setLatLngs(pts);
  }

  async function refreshLive() {
    try {
      const res = await fetch(WORKER_URL, { cache: "no-store" });
      const data = await res.json();

      // Tu Worker devuelve: { ok:true, time:..., camion1:..., camion2:... }
      if (data && data.ok) {
        lastUpdateOk = true;

        // Ojo: a veces GPSEyes devuelve items vacÃ­os si no hay datos recientes
        if (data.camion1) applyDevice(data.camion1);
        if (data.camion2) applyDevice(data.camion2);

        // Si quieres tambiÃ©n soportar cuando el Worker devuelve "items" directo:
        if (!data.camion1 && !data.camion2 && Array.isArray(data.items)) {
          for (const it of data.items) applyDevice(it);
        }

        updateLivePill(true);
      } else {
        updateLivePill(false);
      }

    } catch (e) {
      updateLivePill(false);
    }
  }

  function updateLivePill(ok) {
    const dot = document.getElementById("live-dot");
    const txt = document.getElementById("live-text");
    if (ok) {
      dot.classList.remove("dot-off");
      dot.classList.add("dot");
      txt.textContent = "En vivo (actualizando)";
    } else {
      dot.classList.add("dot-off");
      txt.textContent = "En vivo (sin datos / reintentando)";
    }
  }

  // =========================
  // HORARIO UI
  // Mapa: 05:00â€“23:59
  // Cochera overlay: 00:00â€“04:59
  // =========================
  function updateScheduleUI() {
    const now = new Date();
    const hour = now.getHours();

    const overlay = document.getElementById("cochera-overlay");
    const isCochera = (hour >= 0 && hour < 5);

    // Mapa siempre visible, solo overlay en cochera
    overlay.style.display = isCochera ? "flex" : "none";
  }

  // =========================
  // CHATBOT (tu cÃ³digo igual)
  // =========================
  const botBtn = document.getElementById("chatbot-button");
  const botWindow = document.getElementById("chatbot-window");
  const messages = document.getElementById("chatbot-messages");
  const input = document.getElementById("user-input");
  const sendBtn = document.getElementById("send-btn");

  let step = 0;
  let dataChat = { name: "", direccion: "", incidencia: "" };

  function botSay(text) {
    const div = document.createElement("div");
    div.className = "msg bot";
    div.innerHTML = text;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
  }

  function userSay(text) {
    const div = document.createElement("div");
    div.className = "msg user";
    div.innerHTML = text;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
  }

  botBtn.onclick = () => {
    botWindow.style.display = (botWindow.style.display === "flex" ? "none" : "flex");
    if (messages.innerHTML.trim() === "") startChat();
  };

  function startChat() {
    step = 0;
    botSay("ðŸ‘‹ Hola vecino, gracias por apoyar el monitoreo ciudadano.");
    setTimeout(() => botSay("Â¿CuÃ¡l es tu nombre?"), 600);
  }

  sendBtn.onclick = () => processUserMessage();
  input.addEventListener("keypress", (e) => { if (e.key === "Enter") processUserMessage(); });

  function processUserMessage() {
    const text = input.value.trim();
    if (!text) return;
    userSay(text);
    input.value = "";

    if (step === 0) {
      dataChat.name = text;
      step = 1;
      setTimeout(() => botSay("Â¿En quÃ© direcciÃ³n ocurre el problema?"), 500);
    } else if (step === 1) {
      dataChat.direccion = text;
      step = 2;
      setTimeout(() => botSay("Por favor describe la incidencia."), 500);
    } else if (step === 2) {
      dataChat.incidencia = text;
      step = 3;
      sendReport();
    }
  }

  function sendReport() {
    botSay("â³ Enviando reporte, por favor espera...");

    const msg = "DirecciÃ³n: " + dataChat.direccion + "\n" + "Incidencia: " + dataChat.incidencia;

    emailjs.send("service_6n1vp4m", "template_7yj72fo", {
      name: dataChat.name,
      time: new Date().toLocaleString(),
      message: msg
    })
    .then(() => botSay("âœ”ï¸ Â¡Tu reporte fue enviado por correo!"))
    .catch(() => botSay("âŒ Hubo un problema al enviar el correo."));
  }

  // =========================
  // INIT
  // =========================
  window.addEventListener("load", () => {
    initMap();
    updateScheduleUI();
    setInterval(updateScheduleUI, 60 * 1000);

    // En vivo automÃ¡tico
    refreshLive();
    setInterval(refreshLive, REFRESH_MS);
  });

</script>

</body>
</html>
