<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Monitoreo Ciudadano - Bellavista</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script>
    emailjs.init({ publicKey: "IGGKWnrPTdwnN39yS" });
  </script>

  <style>
    body { font-family: 'Inter', sans-serif; background: #f3f4f6; }

    #gmap {
      width: 100%;
      height: 80vh;
      border-radius: 16px;
      box-shadow: 0 12px 28px rgba(0,0,0,0.18);
    }

    /* Chat */
    #chatbot-button {
      position: fixed; bottom: 25px; right: 25px;
      background: #1e3a8a; color: white;
      width: 65px; height: 65px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 28px; cursor: pointer;
      box-shadow: 0 6px 15px rgba(0,0,0,0.3);
      z-index: 9999;
    }

    #chatbot-window {
      width: 330px; height: 480px; background: white;
      position: fixed; bottom: 100px; right: 25px;
      border-radius: 15px; box-shadow: 0 0 20px rgba(0,0,0,0.25);
      display: none; flex-direction: column; overflow: hidden;
      z-index: 9999;
    }

    #chatbot-messages {
      flex: 1; padding: 10px; overflow-y: auto; background: #e5e7eb;
    }

    .msg {
      margin-bottom: 10px; padding: 10px 14px;
      max-width: 80%; border-radius: 12px;
      font-size: 14px;
    }

    .bot { background: white; }
    .user { background: #1e3a8a; color: white; margin-left: auto; }

    #chat-input-box {
      display: flex; padding: 8px; border-top: 1px solid #ddd;
    }

    #user-input {
      flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 8px;
    }

    #send-btn {
      margin-left: 6px; background: #1e3a8a; color: white;
      padding: 8px 14px; border-radius: 8px; cursor: pointer;
    }
  </style>
</head>

<body>

<!-- HEADER -->
<header class="relative shadow-xl py-3 px-4 flex items-center justify-center">
  <div class="absolute inset-0 bg-gradient-to-r from-blue-900 via-blue-800 to-blue-900 opacity-95"></div>
  <div class="relative z-10 flex items-center gap-4 text-white">
    <img src="./logo-bellavista.jpeg"
         onerror="this.src='https://placehold.co/100x100/1e3a8a/ffffff?text=LOGO'"
         class="h-14 w-14 rounded-full shadow-xl ring-2 ring-white/40">
    <div>
      <div class="text-sm text-blue-200 uppercase font-semibold">
        Municipalidad Distrital de Bellavista
      </div>
      <h1 class="text-xl md:text-2xl font-extrabold">
        Monitoreo Ciudadano de Camiones Compactadores
      </h1>
    </div>
  </div>
</header>

<!-- MAPA -->
<main class="p-4">
  <div id="gmap"></div>
</main>

<!-- CHATBOT -->
<div id="chatbot-button">ðŸ’¬</div>
<div id="chatbot-window">
  <div id="chatbot-messages"></div>
  <div id="chat-input-box">
    <input type="text" id="user-input" placeholder="Escribe aquÃ­...">
    <button id="send-btn">Enviar</button>
  </div>
</div>

<script>
/* =========================
   CONFIG
========================= */
const WORKER_URL = "https://gps-bellavista.karolmauricio12.workers.dev/";
const POLL_MS = 5000;

/* =========================
   MAPA
========================= */
let map;
let marker1, marker2;
let poly1, poly2;
let path1 = [], path2 = [];
let lastKnown = { camion1: null, camion2: null };

function initMap() {
  map = new google.maps.Map(document.getElementById("gmap"), {
    center: { lat: -4.8844, lng: -80.6778 },
    zoom: 14,
    mapTypeId: "hybrid",
    mapTypeControl: true,
    streetViewControl: false,
    fullscreenControl: true
  });

  poly1 = new google.maps.Polyline({
    map, path: path1,
    strokeColor: "#FFD400", strokeOpacity: 0.95, strokeWeight: 5
  });

  poly2 = new google.maps.Polyline({
    map, path: path2,
    strokeColor: "#FFD400", strokeOpacity: 0.95, strokeWeight: 5
  });

  marker1 = createMarker("COMPACTADOR");
  marker2 = createMarker("COMPACTADOR 2");

  refresh();
  setInterval(refresh, POLL_MS);
}

function createMarker(label) {
  return new google.maps.Marker({
    map,
    label: { text: label, color: "#111", fontWeight: "700" },
    icon: {
      url: "https://cdn-icons-png.flaticon.com/512/1995/1995470.png",
      scaledSize: new google.maps.Size(44, 44),
      labelOrigin: new google.maps.Point(22, -6)
    }
  });
}

function addPoint(path, lat, lng) {
  const last = path[path.length - 1];
  if (!last || last.lat() !== lat || last.lng() !== lng) {
    path.push(new google.maps.LatLng(lat, lng));
  }
}

async function refresh() {
  try {
    const r = await fetch(WORKER_URL, { cache: "no-store" });
    const data = await r.json();

    if (data.camion1) lastKnown.camion1 = data.camion1;
    if (data.camion2) lastKnown.camion2 = data.camion2;

    if (lastKnown.camion1) {
      const { lat, lng, name } = lastKnown.camion1;
      const p = { lat: Number(lat), lng: Number(lng) };
      marker1.setPosition(p);
      marker1.setLabel({ text: name || "COMPACTADOR", color: "#111", fontWeight: "700" });
      addPoint(path1, p.lat, p.lng);
      poly1.setPath(path1);
    }

    if (lastKnown.camion2) {
      const { lat, lng, name } = lastKnown.camion2;
      const p = { lat: Number(lat), lng: Number(lng) };
      marker2.setPosition(p);
      marker2.setLabel({ text: name || "COMPACTADOR 2", color: "#111", fontWeight: "700" });
      addPoint(path2, p.lat, p.lng);
      poly2.setPath(path2);
    }

  } catch (e) {
    console.error("Error:", e);
  }
}
</script>

<!-- GOOGLE MAPS -->
<script async
  src="https://maps.googleapis.com/maps/api/js?key=TU_GOOGLE_MAPS_KEY_AQUI&callback=initMap">
</script>

<script>
/* =========================
   CHATBOT (igual al tuyo)
========================= */
const botBtn = document.getElementById("chatbot-button");
const botWindow = document.getElementById("chatbot-window");
const messages = document.getElementById("chatbot-messages");
const input = document.getElementById("user-input");
const sendBtn = document.getElementById("send-btn");

let step = 0;
let data = { name: "", direccion: "", incidencia: "" };

function botSay(t){ const d=document.createElement("div"); d.className="msg bot"; d.innerHTML=t; messages.appendChild(d); messages.scrollTop=messages.scrollHeight; }
function userSay(t){ const d=document.createElement("div"); d.className="msg user"; d.innerHTML=t; messages.appendChild(d); messages.scrollTop=messages.scrollHeight; }

botBtn.onclick=()=>{ botWindow.style.display=botWindow.style.display==="flex"?"none":"flex"; if(!messages.innerHTML)startChat(); };
function startChat(){ step=0; botSay("ðŸ‘‹ Hola vecino, gracias por apoyar el monitoreo ciudadano."); setTimeout(()=>botSay("Â¿CuÃ¡l es tu nombre?"),600); }
sendBtn.onclick=process;
input.onkeypress=e=>{ if(e.key==="Enter")process(); };

function process(){
  const t=input.value.trim(); if(!t)return;
  userSay(t); input.value="";
  if(step==
