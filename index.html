<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Monitoreo Ciudadano - Bellavista</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- EmailJS v4 -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script>
    emailjs.init({ publicKey: "IGGKWnrPTdwnN39yS" });
  </script>

  <style>
    body { font-family: 'Inter', sans-serif; background: #f3f4f6; }

    /* MAPA */
    #gmap {
      width: 100%;
      height: 80vh;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    }

    /* BOT√ìN FLOTANTE */
    #chatbot-button {
      position: fixed;
      bottom: 25px;
      right: 25px;
      background: #1e3a8a;
      color: white;
      width: 65px;
      height: 65px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      cursor: pointer;
      box-shadow: 0 6px 15px rgba(0,0,0,0.3);
      z-index: 9999;
    }

    /* VENTANA DEL CHAT */
    #chatbot-window {
      width: 330px;
      height: 480px;
      background: white;
      position: fixed;
      bottom: 100px;
      right: 25px;
      border-radius: 15px;
      box-shadow: 0 0 20px rgba(0,0,0,0.25);
      display: none;
      flex-direction: column;
      overflow: hidden;
      z-index: 9999;
    }

    #chatbot-messages {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      background: #e5e7eb;
    }

    .msg {
      margin-bottom: 10px;
      padding: 10px 14px;
      max-width: 80%;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.3;
    }

    .bot { background: white; color: black; }
    .user { background: #1e3a8a; color: white; margin-left: auto; }

    #chat-input-box {
      display: flex;
      padding: 8px;
      border-top: 1px solid #ddd;
      background: white;
    }

    #user-input {
      flex: 1;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 8px;
    }

    #send-btn {
      margin-left: 6px;
      background: #1e3a8a;
      color: white;
      padding: 8px 14px;
      border-radius: 8px;
      cursor: pointer;
    }

    /* ANIMACIONES PRO */
    @keyframes fadeIn {
      0% { opacity: 0; transform: scale(0.95); }
      100% { opacity: 1; transform: scale(1); }
    }
    @keyframes slideUp {
      0% { opacity: 0; transform: translateY(25px); }
      100% { opacity: 1; transform: translateY(0); }
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); filter: brightness(1); }
      50% { transform: scale(1.06); filter: brightness(1.15); }
    }
    @keyframes slide {
      0% { transform: translateX(-30px); opacity: 0.3; }
      50% { transform: translateX(30px); opacity: 1; }
      100% { transform: translateX(-30px); opacity: 0.3; }
    }
    @keyframes glow {
      0%   { box-shadow: 0 0 0px 0px rgba(255,255,255,0.0); }
      50%  { box-shadow: 0 0 20px 5px rgba(255,255,255,0.35); }
      100% { box-shadow: 0 0 0px 0px rgba(255,255,255,0.0); }
    }

    /* Overlay cochera encima del mapa (mapa se ve igual detr√°s) */
    #cochera-overlay {
      position: absolute;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 24px;
      z-index: 20;
    }

    /* Contenedor relativo para overlay encima del mapa */
    #map-wrap {
      position: relative;
    }
  </style>
</head>

<body>

<!-- HEADER PRO -->
<header class="relative shadow-xl py-3 px-4 flex items-center justify-center">
  <div class="absolute inset-0 bg-gradient-to-r from-blue-900 via-blue-800 to-blue-900 opacity-95"></div>

  <div class="relative z-10 flex items-center gap-4 select-none">
    <!-- LOGO ANIMADO -->
    <div class="relative">
      <img
        src="./logo-bellavista.jpeg"
        onerror="this.src='https://placehold.co/100x100/1e3a8a/ffffff?text=LOGO'"
        class="h-14 w-14 md:h-16 md:w-16 rounded-full object-cover shadow-xl
               ring-2 ring-white/40 animate-[pulse_4s_ease-in-out_infinite]"
      >
      <div class="absolute inset-0 rounded-full animate-[glow_3s_infinite]"></div>
    </div>

    <!-- TEXTO -->
    <div class="flex flex-col justify-center text-white">
      <span class="text-xs md:text-sm uppercase tracking-wide text-blue-200 font-semibold">
        Municipalidad Distrital de Bellavista
      </span>

      <h1 class="text-lg md:text-2xl font-extrabold leading-tight drop-shadow-lg">
        Monitoreo Ciudadano de Camiones Compactadores
      </h1>

      <div class="mt-1 h-1 w-24 bg-gradient-to-r from-blue-300 to-white rounded-full"></div>
    </div>
  </div>
</header>

<!-- CONTENIDO PRINCIPAL -->
<main class="p-4">
  <!-- MAPA SIEMPRE (con overlay de cochera 00:00‚Äì04:59) -->
  <div id="map-wrap" class="w-full">
    <div id="gmap"></div>

    <!-- OVERLAY DE COCHERA (pero el mapa y camiones siguen visibles debajo) -->
    <div id="cochera-overlay">
      <div class="relative w-full max-w-5xl">
        <div class="absolute inset-0 bg-gradient-to-br from-blue-900 via-blue-800 to-blue-700 opacity-90 rounded-3xl shadow-2xl"></div>

        <div class="relative z-10 backdrop-blur-xl bg-white/10 border border-white/20 rounded-3xl shadow-2xl
                    p-8 md:p-12 flex flex-col md:flex-row items-center gap-10
                    animate-[fadeIn_1s_ease-out]">

          <div class="flex flex-col items-center">
            <img
              src="./logo-bellavista.jpeg"
              onerror="this.src='https://placehold.co/200x200/1e3a8a/ffffff?text=LOGO';"
              class="w-40 h-40 md:w-48 md:h-48 rounded-full shadow-xl object-cover animate-[pulse_3s_infinite] ring-4 ring-white/40"
            >
            <div class="mt-3 w-24 h-1 bg-gradient-to-r from-blue-300 to-white rounded-full animate-[slide_2s_infinite]"></div>
          </div>

          <div class="text-center md:text-left animate-[slideUp_1s_ease-out]">
            <h2 class="text-3xl md:text-4xl font-extrabold mb-4 leading-tight text-white drop-shadow-lg">
              EL SERVICIO DE RECOLECCI√ìN HA CONCLUIDO POR HOY
              <span class="block text-blue-200">NUESTROS CAMIONES EST√ÅN EN COCHERA</span>
            </h2>

            <p class="text-lg md:text-xl mb-3 text-blue-100 font-medium">
              NOS REENCONTRAMOS PRONTO PARA SEGUIR TRABAJANDO POR UN BELLAVISTA LIMPIO.
            </p>

            <p class="text-base md:text-lg text-blue-200 font-semibold">
              GRACIAS POR CUIDAR DE TU CIUDAD.
            </p>

            <p class="mt-6 text-xs md:text-sm text-blue-300 font-light">
              Aviso visible de 00:00 a 04:59 (el mapa sigue activo).
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- BOT√ìN FLOTANTE -->
<div id="chatbot-button">üí¨</div>

<!-- CHATBOT -->
<div id="chatbot-window">
  <div id="chatbot-messages"></div>
  <div id="chat-input-box">
    <input type="text" id="user-input" placeholder="Escribe aqu√≠...">
    <button id="send-btn">Enviar</button>
  </div>
</div>

<script>
  // ====== CONFIG ======
  const WORKER_URL = "https://gps-bellavista.karolmauricio12.workers.dev/"; // tu Worker
  const DEVICE_1_ID = 305; // COMPACTADOR
  const DEVICE_2_ID = 809; // COMPACTADOR 2

  // Puedes cambiar esto a una imagen real (png) en tu repo, por ejemplo: ./truck.png
  // Si no tienes imagen, se usa un SVG inline.
  const TRUCK_ICON_SVG = (fill="#FFD400") => {
    // icono simple de cami√≥n (SVG) para no depender de archivos
    return {
      url: "data:image/svg+xml;charset=UTF-8," + encodeURIComponent(`
        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 64 64">
          <rect x="10" y="22" width="30" height="18" rx="4" fill="${fill}" stroke="#111" stroke-width="2"/>
          <rect x="40" y="26" width="12" height="14" rx="3" fill="${fill}" stroke="#111" stroke-width="2"/>
          <circle cx="20" cy="44" r="5" fill="#111"/>
          <circle cx="44" cy="44" r="5" fill="#111"/>
          <rect x="14" y="26" width="10" height="6" fill="#fff" opacity="0.7"/>
        </svg>
      `),
      scaledSize: new google.maps.Size(44, 44),
      labelOrigin: new google.maps.Point(22, -2) // label arriba
    };
  };

  // ====== ESTADO ======
  let map;
  let truck1Marker, truck2Marker;
  let truck1Line, truck2Line;

  // Para "ruta amarilla" acumulada en vivo (por sesi√≥n)
  let truck1Path = [];
  let truck2Path = [];

  // ====== HORARIO (00:00‚Äì04:59 overlay cochera) ======
  function updateCocheraOverlay() {
    const now = new Date();
    const h = now.getHours();
    const overlay = document.getElementById("cochera-overlay");
    const cochera = (h >= 0 && h < 5); // 00:00 a 04:59
    overlay.style.display = cochera ? "flex" : "none";
  }

  // ====== MAP INIT (Google Maps) ======
  function initMap() {
    // Centro inicial (se reajusta cuando lleguen coords)
    const initialCenter = { lat: -4.8844, lng: -80.6778 };

    map = new google.maps.Map(document.getElementById("gmap"), {
      center: initialCenter,
      zoom: 14,
      mapTypeId: google.maps.MapTypeId.HYBRID, // Sat√©lite + nombres (lo que quieres)
      streetViewControl: false,
      fullscreenControl: true,
      mapTypeControl: true, // permite cambiar entre mapa/sat√©lite etc
      mapTypeControlOptions: {
        style: google.maps.MapTypeControlStyle.DROPDOWN_MENU
      }
    });

    // Polylines amarillas (ruta)
    truck1Line = new google.maps.Polyline({
      map,
      path: truck1Path,
      strokeColor: "#FFD400",
      strokeOpacity: 0.95,
      strokeWeight: 5
    });

    truck2Line = new google.maps.Polyline({
      map,
      path: truck2Path,
      strokeColor: "#FFD400",
      strokeOpacity: 0.95,
      strokeWeight: 5
    });

    // Markers (camiones con nombre arriba)
    truck1Marker = new google.maps.Marker({
      map,
      position: initialCenter,
      icon: TRUCK_ICON_SVG("#FFD400"),
      label: { text: "COMPACTADOR", color: "#111", fontWeight: "700", fontSize: "12px" },
      zIndex: 1000
    });

    truck2Marker = new google.maps.Marker({
      map,
      position: initialCenter,
      icon: TRUCK_ICON_SVG("#FFD400"),
      label: { text: "COMPACTADOR 2", color: "#111", fontWeight: "700", fontSize: "12px" },
      zIndex: 1000
    });

    // En vivo autom√°tico
    updateCocheraOverlay();
    setInterval(updateCocheraOverlay, 60_000);

    refreshLive();              // primera carga inmediata
    setInterval(refreshLive, 5000); // cada 5s
  }

  // ====== UTIL ======
  function pushUnique(pathArr, lat, lng) {
    const last = pathArr[pathArr.length - 1];
    if (last && Math.abs(last.lat() - lat) < 0.00001 && Math.abs(last.lng() - lng) < 0.00001) return;

    pathArr.push(new google.maps.LatLng(lat, lng));

    // cap para no crecer infinito (ajusta si quieres)
    if (pathArr.length > 2500) pathArr.splice(0, pathArr.length - 2500);
  }

  function setFromTail(pathArr, tail) {
    if (!Array.isArray(tail) || tail.length === 0) return;
    // tail viene como [[lat,lng], ...] (seg√∫n tu worker)
    const converted = tail
      .filter(p => Array.isArray(p) && p.length === 2)
      .map(p => new google.maps.LatLng(Number(p[0]), Number(p[1])));

    if (converted.length > 0) {
      pathArr.length = 0;
      pathArr.push(...converted.slice(-2500));
    }
  }

  // ====== LIVE FETCH ======
  async function refreshLive() {
    try {
      const r = await fetch(WORKER_URL, { cache: "no-store" });
      const data = await r.json();

      if (!data.ok) {
        console.warn("Worker ok:false", data);
        return;
      }

      // Tu worker devuelve camion1 / camion2 con el item completo
      const c1 = data.camion1;
      const c2 = data.camion2;

      // Si el worker devuelve null en uno, no pasa nada
      let anyPos = false;

      if (c1 && typeof c1.lat !== "undefined" && typeof c1.lng !== "undefined") {
        const lat = Number(c1.lat);
        const lng = Number(c1.lng);

        // 1) Si hay tail, √∫salo como base (mejor ruta completa reciente)
        if (Array.isArray(c1.tail) && c1.tail.length > 0) setFromTail(truck1Path, c1.tail);

        // 2) agrega el punto actual al final
        pushUnique(truck1Path, lat, lng);

        truck1Line.setPath(truck1Path);
        truck1Marker.setPosition({ lat, lng });

        // Nombre arriba (por si cambia)
        truck1Marker.setLabel({ text: c1.name || "COMPACTADOR", color: "#111", fontWeight: "700", fontSize: "12px" });

        anyPos = true;
      }

      if (c2 && typeof c2.lat !== "undefined" && typeof c2.lng !== "undefined") {
        const lat = Number(c2.lat);
        const lng = Number(c2.lng);

        if (Array.isArray(c2.tail) && c2.tail.length > 0) setFromTail(truck2Path, c2.tail);

        pushUnique(truck2Path, lat, lng);

        truck2Line.setPath(truck2Path);
        truck2Marker.setPosition({ lat, lng });

        truck2Marker.setLabel({ text: c2.name || "COMPACTADOR 2", color: "#111", fontWeight: "700", fontSize: "12px" });

        anyPos = true;
      }

      // Recentrar solo la primera vez que llegue posici√≥n real
      if (anyPos && !window.__didFitBounds) {
        window.__didFitBounds = true;
        const bounds = new google.maps.LatLngBounds();
        if (truck1Path.length) bounds.extend(truck1Path[truck1Path.length - 1]);
        if (truck2Path.length) bounds.extend(truck2Path[truck2Path.length - 1]);
        if (!bounds.isEmpty()) map.fitBounds(bounds);
      }

    } catch (e) {
      console.error("Error refreshLive:", e);
    }
  }

  // ====== CHATBOT (tu mismo c√≥digo) ======
  const botBtn = document.getElementById("chatbot-button");
  const botWindow = document.getElementById("chatbot-window");
  const messages = document.getElementById("chatbot-messages");
  const input = document.getElementById("user-input");
  const sendBtn = document.getElementById("send-btn");

  let step = 0;
  let reportData = { name: "", direccion: "", incidencia: "" };

  function botSay(text) {
    const div = document.createElement("div");
    div.className = "msg bot";
    div.innerHTML = text;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
  }

  function userSay(text) {
    const div = document.createElement("div");
    div.className = "msg user";
    div.innerHTML = text;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
  }

  botBtn.onclick = () => {
    botWindow.style.display = (botWindow.style.display === "flex" ? "none" : "flex");
    if (messages.innerHTML.trim() === "") startChat();
  };

  function startChat() {
    step = 0;
    botSay("üëã Hola vecino, gracias por apoyar el monitoreo ciudadano.");
    setTimeout(() => botSay("¬øCu√°l es tu nombre?"), 600);
  }

  sendBtn.onclick = () => processUserMessage();
  input.addEventListener("keypress", (e) => {
    if (e.key === "Enter") processUserMessage();
  });

  function processUserMessage() {
    const text = input.value.trim();
    if (!text) return;
    userSay(text);
    input.value = "";

    if (step === 0) {
      reportData.name = text;
      step = 1;
      setTimeout(() => botSay("¬øEn qu√© direcci√≥n ocurre el problema?"), 500);
    }
    else if (step === 1) {
      reportData.direccion = text;
      step = 2;
      setTimeout(() => botSay("Por favor describe la incidencia."), 500);
    }
    else if (step === 2) {
      reportData.incidencia = text;
      step = 3;
      sendReport();
    }
  }

  function sendReport() {
    botSay("‚è≥ Enviando reporte, por favor espera...");

    const msg = "Direcci√≥n: " + reportData.direccion + "\n" +
                "Incidencia: " + reportData.incidencia;

    emailjs.send("service_6n1vp4m", "template_7yj72fo", {
      name: reportData.name,
      time: new Date().toLocaleString(),
      message: msg
    })
    .then(() => botSay("‚úîÔ∏è ¬°Tu reporte fue enviado por correo!"))
    .catch(() => botSay("‚ùå Hubo un problema al enviar el correo."));
  }
</script>

<!-- Google Maps JS (SAT√âLITE + CALLES) -->
<script async
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyACZqyFcGlVIhuXsKPgdmWZFXeoRHs8glk&callback=initMap">
</script>

</body>
</html>
