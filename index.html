<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Monitoreo Ciudadano - Bellavista</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Fuente -->
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
  </style>

  <!-- EmailJS v4 -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script>
    emailjs.init({ publicKey: "IGGKWnrPTdwnN39yS" });
  </script>

  <style>
    body { font-family: 'Inter', sans-serif; background: #f3f4f6; }

    /* BOTÃ“N FLOTANTE */
    #chatbot-button {
      position: fixed;
      bottom: 25px;
      right: 25px;
      background: #1e3a8a;
      color: white;
      width: 65px;
      height: 65px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      cursor: pointer;
      box-shadow: 0 6px 15px rgba(0,0,0,0.3);
      z-index: 9999;
    }

    /* VENTANA DEL CHAT */
    #chatbot-window {
      width: 330px;
      height: 480px;
      background: white;
      position: fixed;
      bottom: 100px;
      right: 25px;
      border-radius: 15px;
      box-shadow: 0 0 20px rgba(0,0,0,0.25);
      display: none;
      flex-direction: column;
      overflow: hidden;
      z-index: 9999;
    }

    #chatbot-messages {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      background: #e5e7eb;
    }

    .msg {
      margin-bottom: 10px;
      padding: 10px 14px;
      max-width: 80%;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.3;
      word-wrap: break-word;
    }

    .bot { background: white; color: black; }
    .user { background: #1e3a8a; color: white; margin-left: auto; }

    /* INPUT DE TEXTO */
    #chat-input-box {
      display: flex;
      padding: 8px;
      border-top: 1px solid #ddd;
      background: white;
    }

    #user-input {
      flex: 1;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 8px;
      outline: none;
    }

    #send-btn {
      margin-left: 6px;
      background: #1e3a8a;
      color: white;
      padding: 8px 14px;
      border-radius: 8px;
      cursor: pointer;
    }

    /* ANIMACIONES PRO */
    @keyframes fadeIn {
      0% { opacity: 0; transform: scale(0.95); }
      100% { opacity: 1; transform: scale(1); }
    }
    @keyframes slideUp {
      0% { opacity: 0; transform: translateY(25px); }
      100% { opacity: 1; transform: translateY(0); }
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); filter: brightness(1); }
      50% { transform: scale(1.06); filter: brightness(1.15); }
    }
    @keyframes slide {
      0% { transform: translateX(-30px); opacity: 0.3; }
      50% { transform: translateX(30px); opacity: 1; }
      100% { transform: translateX(-30px); opacity: 0.3; }
    }
    @keyframes glow {
      0%   { box-shadow: 0 0 0px 0px rgba(255,255,255,0.0); }
      50%  { box-shadow: 0 0 20px 5px rgba(255,255,255,0.35); }
      100% { box-shadow: 0 0 0px 0px rgba(255,255,255,0.0); }
    }
  </style>
</head>

<body>

  <!-- HEADER PRO (SIEMPRE VISIBLE CON LOGO) -->
  <header class="relative shadow-xl py-3 px-4 flex items-center justify-center">
    <div class="absolute inset-0 bg-gradient-to-r from-blue-900 via-blue-800 to-blue-900 opacity-95"></div>

    <div class="relative z-10 flex items-center gap-4 select-none">
      <!-- LOGO -->
      <div class="relative">
        <img
          src="./logo-bellavista.jpeg"
          onerror="this.src='https://placehold.co/100x100/1e3a8a/ffffff?text=LOGO'"
          class="h-14 w-14 md:h-16 md:w-16 rounded-full object-cover shadow-xl ring-2 ring-white/40 animate-[pulse_4s_ease-in-out_infinite]"
          alt="Logo Bellavista"
        >
        <div class="absolute inset-0 rounded-full animate-[glow_3s_infinite]"></div>
      </div>

      <!-- TEXTO -->
      <div class="flex flex-col justify-center text-white">
        <span class="text-xs md:text-sm uppercase tracking-wide text-blue-200 font-semibold">
          Municipalidad Distrital de Bellavista
        </span>

        <h1 class="text-lg md:text-2xl font-extrabold leading-tight drop-shadow-lg">
          Monitoreo Ciudadano de Camiones Compactadores
        </h1>

        <div class="mt-1 h-1 w-24 bg-gradient-to-r from-blue-300 to-white rounded-full"></div>
      </div>
    </div>
  </header>

  <main class="p-4">

    <!-- BANDA DINÃMICA (SOLO CUANDO ESTÃ EL MAPA) -->
    <div id="turno-banner" class="hidden mb-3">
      <div id="turno-bg"
        class="w-full rounded-xl px-6 py-3 text-white text-center font-semibold shadow-lg">
        <span id="turno-text"></span>
      </div>
    </div>

    <!-- SECCIÃ“N MAPA -->
    <div id="map-section" class="hidden">
      <iframe
        src="https://monitoreo.gpseyes.pe/sharing/f26738032cc992ea790a7a6d80f5b066"
        class="w-full h-[80vh] rounded-xl shadow-xl"
        frameborder="0"
        allowfullscreen>
      </iframe>
    </div>

    <!-- SECCIÃ“N COCHERA (CON LOGO TAMBIÃ‰N, NO SE PIERDE) -->
    <div id="cochera-section" class="hidden flex items-center justify-center h-[80vh]">
      <div class="relative w-full flex items-center justify-center p-6">

        <!-- Fondo PRO -->
        <div class="absolute inset-0 bg-gradient-to-br from-blue-900 via-blue-800 to-blue-700 opacity-95 rounded-3xl shadow-2xl"></div>

        <!-- TARJETA PRO -->
        <div class="relative z-10 backdrop-blur-xl bg-white/10 border border-white/20 rounded-3xl shadow-2xl
                    p-8 md:p-12 max-w-5xl w-full flex flex-col md:flex-row items-center gap-10
                    animate-[fadeIn_1s_ease-out]">

          <!-- LOGO -->
          <div class="flex flex-col items-center">
            <img
              src="./logo-bellavista.jpeg"
              onerror="this.src='https://placehold.co/200x200/1e3a8a/ffffff?text=LOGO';"
              class="w-40 h-40 md:w-48 md:h-48 rounded-full shadow-xl object-cover animate-[pulse_3s_infinite] ring-4 ring-white/40"
              alt="Logo Bellavista"
            >
            <div class="mt-3 w-24 h-1 bg-gradient-to-r from-blue-300 to-white rounded-full animate-[slide_2s_infinite]"></div>
          </div>

          <!-- TEXTO -->
          <div class="text-center md:text-left animate-[slideUp_1s_ease-out]">
            <h2 class="text-3xl md:text-4xl font-extrabold mb-4 leading-tight text-white drop-shadow-lg">
              CAMIONES EN COCHERA
              <span class="block text-blue-200">Servicio no disponible</span>
            </h2>

            <p class="text-lg md:text-xl mb-3 text-blue-100 font-medium">
              El servicio de recolecciÃ³n no se encuentra operativo en este horario.
            </p>

            <p class="text-base md:text-lg text-blue-200 font-semibold">
              Gracias por apoyar el monitoreo ciudadano.
            </p>

            <p class="mt-6 text-xs md:text-sm text-blue-300 font-light">
              Horario de monitoreo: 5:00 a.m. â€“ 1:00 p.m. y 2:00 p.m. â€“ 9:30 p.m.
              <br>
              (Cochera: 1:00â€“2:00 p.m. y 9:30 p.m.â€“5:00 a.m.)
            </p>
          </div>

        </div>
      </div>
    </div>

  </main>

  <!-- BOTÃ“N FLOTANTE -->
  <div id="chatbot-button">ðŸ’¬</div>

  <!-- CHATBOT -->
  <div id="chatbot-window">
    <div id="chatbot-messages"></div>
    <div id="chat-input-box">
      <input type="text" id="user-input" placeholder="Escribe aquÃ­...">
      <button id="send-btn">Enviar</button>
    </div>
  </div>

  <script>
    // ========= HORARIO: COCHERA 1:00â€“2:00 PM y 9:30 PMâ€“5:00 AM =========
    function two(n){ return String(n).padStart(2,"0"); }
    function inRange(startMin, endMin, nowMin){
      // rango normal (start < end): start <= now < end
      // rango que cruza medianoche (start > end): now >= start OR now < end
      return startMin <= endMin
        ? (nowMin >= startMin && nowMin < endMin)
        : (nowMin >= startMin || nowMin < endMin);
    }

    function configurarVista(){
      const now = new Date();
      const h = now.getHours();
      const m = now.getMinutes();
      const nowMin = h*60 + m;

      const map = document.getElementById("map-section");
      const cochera = document.getElementById("cochera-section");
      const banner = document.getElementById("turno-banner");
      const text = document.getElementById("turno-text");
      const bg = document.getElementById("turno-bg");

      // Cochera 1:00 pm a 2:00 pm
      const cocheraPausa = inRange(13*60, 14*60, nowMin);
      // Cochera 9:30 pm a 5:00 am (cruza medianoche)
      const cocheraNoche = inRange(21*60 + 30, 5*60, nowMin);

      const horaTxt = `${two(h)}:${two(m)}`;

      // Si estÃ¡ en cochera: ocultar mapa y banner, mostrar cochera
      if (cocheraPausa || cocheraNoche){
        map.classList.add("hidden");
        banner.classList.add("hidden");
        cochera.classList.remove("hidden");
        return;
      }

      // Si NO estÃ¡ en cochera: mostrar mapa y banner, ocultar cochera
      cochera.classList.add("hidden");
      map.classList.remove("hidden");
      banner.classList.remove("hidden");

      // ========= MENSAJE DINÃMICO SEGÃšN TURNO (CUANDO ESTÃ MAPA) =========
      // Turno maÃ±ana: 5:00 a 12:59 (5:00â€“13:00)
      // Turno tarde: 14:00 a 21:29 (14:00â€“21:30)
      if (inRange(5*60, 13*60, nowMin)){
        text.textContent = `ðŸŸ¢ TURNO MAÃ‘ANA ACTIVO Â· ${horaTxt}`;
        bg.className = "w-full rounded-xl px-6 py-3 text-white text-center font-semibold shadow-lg bg-gradient-to-r from-green-600 to-emerald-500";
      } else if (inRange(14*60, 21*60 + 30, nowMin)){
        text.textContent = `ðŸ”µ TURNO TARDE ACTIVO Â· ${horaTxt}`;
        bg.className = "w-full rounded-xl px-6 py-3 text-white text-center font-semibold shadow-lg bg-gradient-to-r from-blue-600 to-cyan-500";
      } else {
        // Este else casi no deberÃ­a ocurrir por el if de cochera, pero lo dejamos seguro:
        text.textContent = `â„¹ï¸ Monitoreo Â· ${horaTxt}`;
        bg.className = "w-full rounded-xl px-6 py-3 text-white text-center font-semibold shadow-lg bg-gradient-to-r from-slate-600 to-slate-500";
      }
    }

    window.addEventListener("load", configurarVista);
    setInterval(configurarVista, 20000);

    // ========= CHATBOT + EMAIL =========
    const botBtn = document.getElementById("chatbot-button");
    const botWindow = document.getElementById("chatbot-window");
    const messages = document.getElementById("chatbot-messages");
    const input = document.getElementById("user-input");
    const sendBtn = document.getElementById("send-btn");

    let step = 0;
    let data = { name: "", direccion: "", incidencia: "" };

    function botSay(text) {
      const div = document.createElement("div");
      div.className = "msg bot";
      div.innerHTML = text;
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
    }

    function userSay(text) {
      const div = document.createElement("div");
      div.className = "msg user";
      div.innerHTML = text;
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
    }

    botBtn.onclick = () => {
      botWindow.style.display = (botWindow.style.display === "flex" ? "none" : "flex");
      if (messages.innerHTML.trim() === "") startChat();
    };

    function startChat() {
      step = 0;
      data = { name: "", direccion: "", incidencia: "" };
      botSay("ðŸ‘‹ Hola vecino, gracias por apoyar el monitoreo ciudadano.");
      setTimeout(() => botSay("Â¿CuÃ¡l es tu nombre?"), 600);
    }

    sendBtn.onclick = () => processUserMessage();
    input.addEventListener("keypress", (e) => {
      if (e.key === "Enter") processUserMessage();
    });

    function processUserMessage() {
      const text = input.value.trim();
      if (!text) return;
      userSay(text);
      input.value = "";

      if (step === 0) {
        data.name = text;
        step = 1;
        setTimeout(() => botSay("Â¿En quÃ© direcciÃ³n ocurre el problema?"), 500);
      } else if (step === 1) {
        data.direccion = text;
        step = 2;
        setTimeout(() => botSay("Por favor describe la incidencia."), 500);
      } else if (step === 2) {
        data.incidencia = text;
        step = 3;
        sendReport();
      }
    }

    function sendReport() {
      botSay("â³ Enviando reporte, por favor espera...");

      const msg =
        "DirecciÃ³n: " + data.direccion + "\n" +
        "Incidencia: " + data.incidencia;

      emailjs.send("service_6n1vp4m", "template_7yj72fo", {
        name: data.name,
        time: new Date().toLocaleString(),
        message: msg
      })
      .then(() => {
        botSay("âœ”ï¸ Â¡Tu reporte fue enviado por correo!");
        setTimeout(() => botSay("Â¿Deseas reportar otra incidencia? (Escribe: SI)"), 700);
        step = 99;
      })
      .catch(() => {
        botSay("âŒ Hubo un problema al enviar el correo.");
        setTimeout(() => botSay("Intenta nuevamente en unos segundos."), 700);
        step = 2; // volver a pedir incidencia
      });
    }

    // Opcional: si el usuario escribe "SI" despuÃ©s de enviar, reiniciar flujo
    input.addEventListener("input", () => {});
    function handlePostSend(text){
      if (text.trim().toLowerCase() === "si"){
        startChat();
      } else {
        botSay("Perfecto âœ…. Gracias por apoyar a Bellavista.");
      }
    }

    // Interceptamos cuando step=99
    const originalProcess = processUserMessage;
    window.processUserMessage = function(){
      const text = input.value.trim();
      if (!text) return;
      userSay(text);
      input.value = "";
      if(step === 99){
        handlePostSend(text);
        return;
      }
      // reconstruir el flujo normal
      if (step === 0) {
        data.name = text;
        step = 1;
        setTimeout(() => botSay("Â¿En quÃ© direcciÃ³n ocurre el problema?"), 500);
      } else if (step === 1) {
        data.direccion = text;
        step = 2;
        setTimeout(() => botSay("Por favor describe la incidencia."), 500);
      } else if (step === 2) {
        data.incidencia = text;
        step = 3;
        sendReport();
      }
    };
    // Asegurar que el botÃ³n/enter llamen a la versiÃ³n final
    sendBtn.onclick = () => window.processUserMessage();
    input.addEventListener("keypress", (e) => {
      if (e.key === "Enter") window.processUserMessage();
    });
  </script>

</body>
</html>
