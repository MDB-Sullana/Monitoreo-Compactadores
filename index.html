<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Monitoreo Ciudadano - Bellavista</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- EmailJS v4 -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script>
    emailjs.init({ publicKey: "IGGKWnrPTdwnN39yS" });
  </script>

  <style>
    body { font-family: 'Inter', sans-serif; background: #f3f4f6; }

    /* Contenedor del mapa */
    #leaflet-map {
      width: 100%;
      height: 80vh;
      border-radius: 14px;
      box-shadow: 0 16px 30px rgba(0,0,0,0.20);
      overflow: hidden;
    }

    /* BOT√ìN FLOTANTE */
    #chatbot-button {
      position: fixed;
      bottom: 25px;
      right: 25px;
      background: #1e3a8a;
      color: white;
      width: 65px;
      height: 65px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      cursor: pointer;
      box-shadow: 0 6px 15px rgba(0,0,0,0.3);
      z-index: 9999;
    }

    /* VENTANA DEL CHAT */
    #chatbot-window {
      width: 330px;
      height: 480px;
      background: white;
      position: fixed;
      bottom: 100px;
      right: 25px;
      border-radius: 15px;
      box-shadow: 0 0 20px rgba(0,0,0,0.25);
      display: none;
      flex-direction: column;
      overflow: hidden;
      z-index: 9999;
    }

    #chatbot-messages {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      background: #e5e7eb;
    }

    .msg {
      margin-bottom: 10px;
      padding: 10px 14px;
      max-width: 80%;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.3;
    }

    .bot { background: white; color: black; }
    .user { background: #1e3a8a; color: white; margin-left: auto; }

    /* INPUT DE TEXTO */
    #chat-input-box {
      display: flex;
      padding: 8px;
      border-top: 1px solid #ddd;
      background: white;
    }

    #user-input {
      flex: 1;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 8px;
    }

    #send-btn {
      margin-left: 6px;
      background: #1e3a8a;
      color: white;
      padding: 8px 14px;
      border-radius: 8px;
      cursor: pointer;
    }

    /* ANIMACIONES PRO */
    @keyframes fadeIn {
      0% { opacity: 0; transform: scale(0.95); }
      100% { opacity: 1; transform: scale(1); }
    }
    @keyframes slideUp {
      0% { opacity: 0; transform: translateY(25px); }
      100% { opacity: 1; transform: translateY(0); }
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); filter: brightness(1); }
      50% { transform: scale(1.06); filter: brightness(1.15); }
    }
    @keyframes slide {
      0% { transform: translateX(-30px); opacity: 0.3; }
      50% { transform: translateX(30px); opacity: 1; }
      100% { transform: translateX(-30px); opacity: 0.3; }
    }
    @keyframes glow {
      0%   { box-shadow: 0 0 0px 0px rgba(255,255,255,0.0); }
      50%  { box-shadow: 0 0 20px 5px rgba(255,255,255,0.35); }
      100% { box-shadow: 0 0 0px 0px rgba(255,255,255,0.0); }
    }

    /* Caja ‚Äúestado en vivo‚Äù */
    #live-status {
      margin-top: 10px;
      font-size: 12px;
      color: #334155;
      background: #ffffff;
      border-radius: 10px;
      padding: 10px 12px;
      box-shadow: 0 8px 18px rgba(0,0,0,0.08);
    }
  </style>
</head>

<body>

<!-- HEADER PRO -->
<header class="relative shadow-xl py-3 px-4 flex items-center justify-center">
  <div class="absolute inset-0 bg-gradient-to-r from-blue-900 via-blue-800 to-blue-900 opacity-95"></div>

  <div class="relative z-10 flex items-center gap-4 select-none">
    <!-- LOGO ANIMADO -->
    <div class="relative">
      <img
        src="./logo-bellavista.jpeg"
        onerror="this.src='https://placehold.co/100x100/1e3a8a/ffffff?text=LOGO'"
        class="h-14 w-14 md:h-16 md:w-16 rounded-full object-cover shadow-xl ring-2 ring-white/40 animate-[pulse_4s_ease-in-out_infinite]"
      >
      <div class="absolute inset-0 rounded-full animate-[glow_3s_infinite]"></div>
    </div>

    <!-- TEXTO -->
    <div class="flex flex-col justify-center text-white">
      <span class="text-xs md:text-sm uppercase tracking-wide text-blue-200 font-semibold">
        Municipalidad Distrital de Bellavista
      </span>
      <h1 class="text-lg md:text-2xl font-extrabold leading-tight drop-shadow-lg">
        Monitoreo Ciudadano de Camiones Compactadores
      </h1>
      <div class="mt-1 h-1 w-24 bg-gradient-to-r from-blue-300 to-white rounded-full"></div>
    </div>
  </div>
</header>

<!-- CONTENIDO PRINCIPAL -->
<main class="p-4">

  <!-- SECCI√ìN MAPA (05:00 a 23:59) -->
  <div id="map-section" class="hidden">
    <div id="leaflet-map"></div>
    <div id="live-status" class="max-w-full">
      <b>En vivo:</b> conectando‚Ä¶
      <div id="live-detail" class="mt-1 text-slate-600">‚Äî</div>
    </div>
  </div>

  <!-- SECCI√ìN COCHERA (00:00 a 04:59) -->
  <div id="cochera-section" class="hidden flex items-center justify-center h-[80vh]">
    <div class="relative w-full flex items-center justify-center p-6">
      <div class="absolute inset-0 bg-gradient-to-br from-blue-900 via-blue-800 to-blue-700 opacity-95 rounded-3xl shadow-2xl"></div>

      <div class="relative z-10 backdrop-blur-xl bg-white/10 border border-white/20 rounded-3xl shadow-2xl
                  p-8 md:p-12 max-w-5xl w-full flex flex-col md:flex-row items-center gap-10
                  animate-[fadeIn_1s_ease-out]">
        <div class="flex flex-col items-center">
          <img
            src="./logo-bellavista.jpeg"
            onerror="this.src='https://placehold.co/200x200/1e3a8a/ffffff?text=LOGO';"
            class="w-40 h-40 md:w-48 md:h-48 rounded-full shadow-xl object-cover animate-[pulse_3s_infinite] ring-4 ring-white/40"
          >
          <div class="mt-3 w-24 h-1 bg-gradient-to-r from-blue-300 to-white rounded-full animate-[slide_2s_infinite]"></div>
        </div>

        <div class="text-center md:text-left animate-[slideUp_1s_ease-out]">
          <h2 class="text-3xl md:text-4xl font-extrabold mb-4 leading-tight text-white drop-shadow-lg">
            NUESTROS CAMIONES EST√ÅN EN COCHERA
            <span class="block text-blue-200">FUERA DE HORARIO DE MONITOREO</span>
          </h2>

          <p class="text-lg md:text-xl mb-3 text-blue-100 font-medium">
            El mapa vuelve a mostrarse desde las <b>05:00</b>.
          </p>

          <p class="text-base md:text-lg text-blue-200 font-semibold">
            Gracias por cuidar de tu ciudad.
          </p>

          <p class="mt-6 text-xs md:text-sm text-blue-300 font-light">
            Horario del mapa: de 05:00 a 23:59.
          </p>
        </div>
      </div>
    </div>
  </div>

</main>

<!-- BOT√ìN FLOTANTE -->
<div id="chatbot-button">üí¨</div>

<!-- CHATBOT -->
<div id="chatbot-window">
  <div id="chatbot-messages"></div>
  <div id="chat-input-box">
    <input type="text" id="user-input" placeholder="Escribe aqu√≠...">
    <button id="send-btn">Enviar</button>
  </div>
</div>

<script>
  // =========================
  // 1) L√ìGICA HORARIA (MAPA 05:00‚Äì23:59 | COCHERA 00:00‚Äì04:59)
  // =========================
  function configurarVista() {
    const now = new Date();
    const hour = now.getHours();

    const mapSection = document.getElementById("map-section");
    const cocheraSection = document.getElementById("cochera-section");

    if (hour < 5) { // 00:00 a 04:59
      cocheraSection.classList.remove("hidden");
      mapSection.classList.add("hidden");
    } else {
      mapSection.classList.remove("hidden");
      cocheraSection.classList.add("hidden");
    }
  }

  // =========================
  // 2) MAPA EN VIVO + RUTA AMARILLA
  // =========================
  const WORKER_URL = "https://gps-bellavista.karolmauricio12.workers.dev/";
  const DEVICE_1 = { id: 305, name: "COMPACTADOR" };
  const DEVICE_2 = { id: 809, name: "COMPACTADOR 2" };

  let map = null;
  let layerControl = null;
  let liveTimer = null;
  let didFirstFit = false;

  const state = {
    [DEVICE_1.id]: { marker: null, line: null, lastLatLng: null },
    [DEVICE_2.id]: { marker: null, line: null, lastLatLng: null }
  };

  function initMapOnce() {
    if (map) return;

    // Centro aproximado (ajusta si quieres)
    map = L.map('leaflet-map', { zoomControl: true }).setView([-4.8846, -80.6778], 14);

    // Base maps (sat√©lite + labels por defecto)
    const esriSat = L.tileLayer(
      "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
      { maxZoom: 19 }
    );

    // Labels (nombres encima del sat√©lite)
    const esriLabels = L.tileLayer(
      "https://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}",
      { maxZoom: 19, opacity: 0.95 }
    );

    // Otras capas bonitas (elige la que quieras)
    const osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 });
    const cartoLight = L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png", { maxZoom: 20 });
    const cartoDark = L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", { maxZoom: 20 });

    // Sat√©lite como default
    esriSat.addTo(map);
    esriLabels.addTo(map);

    const baseMaps = {
      "Sat√©lite (predeterminado)": esriSat,
      "OpenStreetMap": osm,
      "Carto Light": cartoLight,
      "Carto Dark": cartoDark
    };

    const overlays = {
      "Nombres de calles (labels)": esriLabels
    };

    layerControl = L.control.layers(baseMaps, overlays, { collapsed: true }).addTo(map);

    // Inicializa marcadores + l√≠neas (amarilla)
    for (const d of [DEVICE_1, DEVICE_2]) {
      state[d.id].line = L.polyline([], { color: "#FFD400", weight: 5, opacity: 0.95 }).addTo(map);
      state[d.id].marker = L.circleMarker([0,0], {
        radius: 9, weight: 2, color: "#0f172a", fillColor: "#22c55e", fillOpacity: 0.95
      }).addTo(map);
      state[d.id].marker.bindPopup(`<b>${d.name}</b><br/>Cargando‚Ä¶`);
      state[d.id].marker.setStyle({ fillColor: d.id === DEVICE_1.id ? "#22c55e" : "#3b82f6" });
    }

    // Arranca ‚ÄúEn vivo‚Äù autom√°ticamente
    startLive();
  }

  function setStatus(text, detail) {
    const live = document.getElementById("live-status");
    const det = document.getElementById("live-detail");
    live.firstChild.textContent = ""; // limpia
    live.innerHTML = `<b>En vivo:</b> ${text}<div id="live-detail" class="mt-1 text-slate-600">${detail || "‚Äî"}</div>`;
  }

  function parseTailToLatLngs(tail) {
    // GPSEyes a veces manda tail como [[lat,lng], ...] o como [{lat,lng}, ...]
    if (!Array.isArray(tail)) return [];
    if (tail.length === 0) return [];
    if (Array.isArray(tail[0])) return tail.map(p => [Number(p[0]), Number(p[1])]).filter(p => isFinite(p[0]) && isFinite(p[1]));
    return tail.map(p => [Number(p.lat), Number(p.lng)]).filter(p => isFinite(p[0]) && isFinite(p[1]));
  }

  function updateDevice(item) {
    if (!item || !item.id) return;

    const id = Number(item.id);
    if (!state[id]) return;

    const lat = Number(item.lat);
    const lng = Number(item.lng);
    if (!isFinite(lat) || !isFinite(lng)) return;

    const latLng = [lat, lng];

    // Marker
    state[id].marker.setLatLng(latLng);

    // Popup info
    const speed = Number(item.speed ?? 0);
    const when = item.time ? item.time : (item.timestamp ? new Date(item.timestamp * 1000).toLocaleString() : "");
    state[id].marker.setPopupContent(
      `<b>${item.name || "Unidad"}</b><br/>Velocidad: <b>${speed}</b><br/>${when ? ("Hora: " + when) : ""}`
    );

    // L√≠nea amarilla: usamos tail (historial corto) + el punto actual
    const tail = parseTailToLatLngs(item.tail);
    const pts = [...tail];

    // Asegura que el √∫ltimo sea el punto actual
    const last = pts[pts.length - 1];
    if (!last || Math.abs(last[0] - lat) > 1e-7 || Math.abs(last[1] - lng) > 1e-7) {
      pts.push(latLng);
    }

    state[id].line.setLatLngs(pts);
    state[id].lastLatLng = latLng;

    // Auto-encuadre una sola vez
    if (!didFirstFit) {
      const allPts = [];
      for (const k of Object.keys(state)) {
        const s = state[k];
        if (s.lastLatLng) allPts.push(s.lastLatLng);
      }
      if (allPts.length) {
        map.fitBounds(L.latLngBounds(allPts), { padding: [40, 40] });
        didFirstFit = true;
      }
    }
  }

  async function pollLive() {
    try {
      const r = await fetch(WORKER_URL, { cache: "no-store" });
      const data = await r.json();

      if (!data.ok) {
        setStatus("error", data.error || "No se pudo leer GPSEyes");
        return;
      }

      const c1 = data.camion1 || null;
      const c2 = data.camion2 || null;

      if (!c1 && !c2) {
        // No borramos el mapa: dejamos lo √∫ltimo y mostramos estado
        setStatus("sin datos ahora", "Las unidades pueden estar detenidas o el sistema no reporta cambios en este momento.");
        return;
      }

      setStatus("activo", `√öltima lectura: ${data.time ? new Date(data.time * 1000).toLocaleString() : "‚Äî"}`);

      if (c1) updateDevice(c1);
      if (c2) updateDevice(c2);

    } catch (e) {
      setStatus("error", "Fallo de conexi√≥n con el Worker.");
      console.error(e);
    }
  }

  function startLive() {
    if (liveTimer) return;
    pollLive();
    liveTimer = setInterval(pollLive, 5000);
  }

  // =========================
  // 3) CHATBOT (tu mismo flujo)
  // =========================
  const botBtn = document.getElementById("chatbot-button");
  const botWindow = document.getElementById("chatbot-window");
  const messages = document.getElementById("chatbot-messages");
  const input = document.getElementById("user-input");
  const sendBtn = document.getElementById("send-btn");

  let step = 0;
  let data = { name: "", direccion: "", incidencia: "" };

  function botSay(text) {
    const div = document.createElement("div");
    div.className = "msg bot";
    div.innerHTML = text;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
  }

  function userSay(text) {
    const div = document.createElement("div");
    div.className = "msg user";
    div.innerHTML = text;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
  }

  botBtn.onclick = () => {
    botWindow.style.display = botWindow.style.display === "flex" ? "none" : "flex";
    if (messages.innerHTML.trim() === "") startChat();
  };

  function startChat() {
    step = 0;
    botSay("üëã Hola vecino, gracias por apoyar el monitoreo ciudadano.");
    setTimeout(() => botSay("¬øCu√°l es tu nombre?"), 600);
  }

  sendBtn.onclick = () => processUserMessage();
  input.addEventListener("keypress", (e) => {
    if (e.key === "Enter") processUserMessage();
  });

  function processUserMessage() {
    const text = input.value.trim();
    if (!text) return;
    userSay(text);
    input.value = "";

    if (step === 0) {
      data.name = text;
      step = 1;
      setTimeout(() => botSay("¬øEn qu√© direcci√≥n ocurre el problema?"), 500);
    }
    else if (step === 1) {
      data.direccion = text;
      step = 2;
      setTimeout(() => botSay("Por favor describe la incidencia."), 500);
    }
    else if (step === 2) {
      data.incidencia = text;
      step = 3;
      sendReport();
    }
  }

  function sendReport() {
    botSay("‚è≥ Enviando reporte, por favor espera...");

    const msg = "Direcci√≥n: " + data.direccion + "\n" + "Incidencia: " + data.incidencia;

    emailjs.send("service_6n1vp4m", "template_7yj72fo", {
      name: data.name,
      time: new Date().toLocaleString(),
      message: msg
    })
    .then(() => botSay("‚úîÔ∏è ¬°Tu reporte fue enviado por correo!"))
    .catch(() => botSay("‚ùå Hubo un problema al enviar el correo."));
  }

  // =========================
  // 4) INICIO (AUTO)
  // =========================
  window.addEventListener("load", () => {
    configurarVista();

    // Inicializa mapa aunque luego se oculte por horario,
    // para que ‚ÄúEn vivo‚Äù arranque autom√°tico cuando corresponda.
    const hour = new Date().getHours();
    if (hour >= 5) {
      setTimeout(initMapOnce, 50);
    }
  });

  // Re-chequea horario cada minuto (por si alguien deja la pesta√±a abierta)
  setInterval(() => {
    configurarVista();
    const hour = new Date().getHours();
    if (hour >= 5) initMapOnce();
  }, 60000);
</script>

</body>
</html>
