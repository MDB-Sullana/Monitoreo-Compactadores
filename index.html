<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Monitoreo Ciudadano - Bellavista</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet (Mapa) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- EmailJS v4 -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script>
    emailjs.init({ publicKey: "IGGKWnrPTdwnN39yS" });
  </script>

  <style>
    body { font-family: 'Inter', sans-serif; background: #f3f4f6; }

    /* MAPA: altura fija para GitHub Pages */
    #leaflet-map { width: 100%; height: 80vh; border-radius: 16px; }

    /* BANNER ESTADO (cochera / en vivo) */
    #status-banner{
      margin-top: 12px;
      padding: 12px 14px;
      border-radius: 14px;
      background: linear-gradient(90deg, rgba(30,58,138,.95), rgba(30,64,175,.95));
      color: white;
      box-shadow: 0 10px 25px rgba(0,0,0,.18);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    #status-badge{
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 700;
      font-size: 12px;
      background: rgba(255,255,255,.18);
      border: 1px solid rgba(255,255,255,.25);
      white-space: nowrap;
    }
    #status-text{ font-size: 14px; line-height: 1.2; color: rgba(255,255,255,.95); }

    /* BOT√ìN FLOTANTE */
    #chatbot-button {
      position: fixed;
      bottom: 25px;
      right: 25px;
      background: #1e3a8a;
      color: white;
      width: 65px;
      height: 65px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      cursor: pointer;
      box-shadow: 0 6px 15px rgba(0,0,0,0.3);
      z-index: 9999;
    }

    /* VENTANA DEL CHAT */
    #chatbot-window {
      width: 330px;
      height: 480px;
      background: white;
      position: fixed;
      bottom: 100px;
      right: 25px;
      border-radius: 15px;
      box-shadow: 0 0 20px rgba(0,0,0,0.25);
      display: none;
      flex-direction: column;
      overflow: hidden;
      z-index: 9999;
    }

    #chatbot-messages {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      background: #e5e7eb;
    }

    .msg {
      margin-bottom: 10px;
      padding: 10px 14px;
      max-width: 80%;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.3;
    }
    .bot { background: white; color: black; }
    .user { background: #1e3a8a; color: white; margin-left: auto; }

    /* INPUT DE TEXTO */
    #chat-input-box {
      display: flex;
      padding: 8px;
      border-top: 1px solid #ddd;
      background: white;
    }

    #user-input {
      flex: 1;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 8px;
    }

    #send-btn {
      margin-left: 6px;
      background: #1e3a8a;
      color: white;
      padding: 8px 14px;
      border-radius: 8px;
      cursor: pointer;
    }

    /* ANIMACIONES PRO */
    @keyframes pulse {
      0%, 100% { transform: scale(1); filter: brightness(1); }
      50% { transform: scale(1.06); filter: brightness(1.15); }
    }
    @keyframes glow {
      0%   { box-shadow: 0 0 0px 0px rgba(255,255,255,0.0); }
      50%  { box-shadow: 0 0 20px 5px rgba(255,255,255,0.35); }
      100% { box-shadow: 0 0 0px 0px rgba(255,255,255,0.0); }
    }
  </style>
</head>

<body>

<!-- HEADER PRO -->
<header class="relative shadow-xl py-3 px-4 flex items-center justify-center">
  <div class="absolute inset-0 bg-gradient-to-r from-blue-900 via-blue-800 to-blue-900 opacity-95"></div>

  <div class="relative z-10 flex items-center gap-4 select-none">
    <div class="relative">
      <img
        src="./logo-bellavista.jpeg"
        onerror="this.src='https://placehold.co/100x100/1e3a8a/ffffff?text=LOGO'"
        class="h-14 w-14 md:h-16 md:w-16 rounded-full object-cover shadow-xl
              ring-2 ring-white/40 animate-[pulse_4s_ease-in-out_infinite]"
      >
      <div class="absolute inset-0 rounded-full animate-[glow_3s_infinite]"></div>
    </div>

    <div class="flex flex-col justify-center text-white">
      <span class="text-xs md:text-sm uppercase tracking-wide text-blue-200 font-semibold">
        Municipalidad Distrital de Bellavista
      </span>

      <h1 class="text-lg md:text-2xl font-extrabold leading-tight drop-shadow-lg">
        Monitoreo Ciudadano de Camiones Compactadores
      </h1>

      <div class="mt-1 h-1 w-24 bg-gradient-to-r from-blue-300 to-white rounded-full"></div>
    </div>
  </div>
</header>

<!-- CONTENIDO PRINCIPAL -->
<main class="p-4">
  <!-- MAPA SIEMPRE VISIBLE -->
  <div class="w-full">
    <div id="leaflet-map" class="shadow-xl"></div>

    <div id="status-banner">
      <div id="status-text">
        Cargando estado del servicio...
      </div>
      <div id="status-badge">EN VIVO</div>
    </div>
  </div>

  <!-- COCHERA PRO (solo como panel informativo, ya no reemplaza al mapa) -->
  <div id="cochera-panel" class="mt-4 hidden">
    <div class="relative w-full flex items-center justify-center p-6">
      <div class="absolute inset-0 bg-gradient-to-br from-blue-900 via-blue-800 to-blue-700 opacity-95 rounded-3xl shadow-2xl"></div>

      <div class="relative z-10 backdrop-blur-xl bg-white/10 border border-white/20 rounded-3xl shadow-2xl
                  p-8 md:p-10 max-w-5xl w-full flex flex-col md:flex-row items-center gap-10">
        <div class="flex flex-col items-center">
          <img
            src="./logo-bellavista.jpeg"
            onerror="this.src='https://placehold.co/200x200/1e3a8a/ffffff?text=LOGO';"
            class="w-36 h-36 md:w-44 md:h-44 rounded-full shadow-xl object-cover animate-[pulse_3s_infinite] ring-4 ring-white/40"
          >
          <div class="mt-3 w-24 h-1 bg-gradient-to-r from-blue-300 to-white rounded-full"></div>
        </div>

        <div class="text-center md:text-left">
          <h2 class="text-2xl md:text-3xl font-extrabold mb-3 leading-tight text-white drop-shadow-lg">
            UNIDADES EN COCHERA
            <span class="block text-blue-200">Se mantiene monitoreo de ubicaci√≥n</span>
          </h2>

          <p class="text-base md:text-lg mb-2 text-blue-100 font-medium">
            Cuando reinicie el turno, la ruta amarilla se dibuja autom√°ticamente.
          </p>

          <p class="text-sm md:text-base text-blue-200 font-semibold">
            Turnos de ruta: 07:00‚Äì12:30 y 14:00‚Äì22:00
          </p>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- BOT√ìN FLOTANTE -->
<div id="chatbot-button">üí¨</div>

<!-- CHATBOT -->
<div id="chatbot-window">
  <div id="chatbot-messages"></div>
  <div id="chat-input-box">
    <input type="text" id="user-input" placeholder="Escribe aqu√≠...">
    <button id="send-btn">Enviar</button>
  </div>
</div>

<script>
  // ==========================
  // 1) CONFIG MAPA + CAPAS
  // ==========================
  const WORKER_URL = "https://gps-bellavista.karolmauricio12.workers.dev/";
  const POLL_MS = 5000;

  const map = L.map('leaflet-map', { zoomControl: true }).setView([-4.885, -80.678], 14);

  const layerOSM = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 20, attribution: '&copy; OpenStreetMap'
  });

  const layerTopo = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
    maxZoom: 17, attribution: '&copy; OpenTopoMap'
  });

  const layerSat = L.tileLayer(
    'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
    { maxZoom: 20, attribution: 'Tiles &copy; Esri' }
  );

  layerOSM.addTo(map);

  L.control.layers(
    { "Mapa (OSM)": layerOSM, "Topogr√°fico": layerTopo, "Sat√©lite": layerSat },
    {},
    { collapsed: true }
  ).addTo(map);

  // ==========================
  // 2) TURNOS (l√≠nea amarilla)
  // ==========================
  function inShiftWindow(now = new Date()) {
    const h = now.getHours();
    const m = now.getMinutes();
    const minutes = h * 60 + m;

    const morningStart = 7 * 60;       // 07:00
    const morningEnd   = 12 * 60 + 30; // 12:30

    const eveningStart = 14 * 60;      // 14:00
    const eveningEnd   = 22 * 60;      // 22:00

    return (minutes >= morningStart && minutes <= morningEnd) ||
           (minutes >= eveningStart && minutes <= eveningEnd);
  }

  function isCocheraTime(now = new Date()) {
    // cochera cuando NO est√° en turno de ruta
    return !inShiftWindow(now);
  }

  let wasInShift = null;

  // ==========================
  // 3) CAMIONES (markers + l√≠nea)
  // ==========================
  const trucks = {
    305: { name: "COMPACTADOR", marker: null, poly: null, points: [] },
    809: { name: "COMPACTADOR 2", marker: null, poly: null, points: [] }
  };

  function setBanner(inShift) {
    const badge = document.getElementById("status-badge");
    const text = document.getElementById("status-text");
    const cocheraPanel = document.getElementById("cochera-panel");

    if (inShift) {
      badge.textContent = "EN VIVO";
      text.innerHTML = "üü° Ruta en vivo activa (dibujando l√≠nea amarilla). Turnos: 07:00‚Äì12:30 y 14:00‚Äì22:00";
      cocheraPanel.classList.add("hidden");
    } else {
      badge.textContent = "COCHERA";
      text.innerHTML = "üöõ Unidades fuera de turno de ruta. Se muestran ubicaciones, la l√≠nea amarilla se pausa y se reinicia al iniciar el pr√≥ximo turno.";
      cocheraPanel.classList.remove("hidden");
    }
  }

  function resetPolylines() {
    for (const id of Object.keys(trucks)) {
      const t = trucks[id];
      t.points = [];
      if (t.poly) { map.removeLayer(t.poly); t.poly = null; }
    }
  }

  function ensureMarker(t, lat, lng) {
    if (!t.marker) {
      t.marker = L.marker([lat, lng]).addTo(map).bindPopup(`<b>${t.name}</b>`);
    } else {
      t.marker.setLatLng([lat, lng]);
    }
  }

  function addPointAndDraw(t, lat, lng) {
    const last = t.points[t.points.length - 1];
    if (last && Math.abs(last[0] - lat) < 0.00001 && Math.abs(last[1] - lng) < 0.00001) return;

    t.points.push([lat, lng]);

    if (!t.poly) {
      t.poly = L.polyline(t.points, { color: "#FFD400", weight: 5, opacity: 0.95 }).addTo(map);
    } else {
      t.poly.setLatLngs(t.points);
    }
  }

  // ==========================
  // 4) LECTURA DEL WORKER (EN VIVO)
  // ==========================
  async function fetchLive() {
    try {
      const r = await fetch(WORKER_URL, { cache: "no-store" });
      const data = await r.json();

      // data = { ok:true, time, camion1, camion2, ... }  (seg√∫n tu worker)
      const nowShift = inShiftWindow(new Date());
      if (wasInShift === null) wasInShift = nowShift;

      // Si cambia de NO turno ‚Üí turno, reiniciamos ruta (empieza ‚Äúl√≠nea nueva‚Äù)
      if (wasInShift === false && nowShift === true) {
        resetPolylines();
      }
      wasInShift = nowShift;
      setBanner(nowShift);

      const list = [];
      if (data && data.camion1) list.push(data.camion1);
      if (data && data.camion2) list.push(data.camion2);

      // Si el worker no manda camion1/camion2, intentamos con item(s)
      if (list.length === 0 && data && data.item) list.push(data.item);
      if (list.length === 0 && data && Array.isArray(data.items)) list.push(...data.items);

      for (const item of list) {
        if (!item || item.lat == null || item.lng == null || item.id == null) continue;

        const id = Number(item.id);
        const t = trucks[id] || { name: item.name || ("ID " + id), marker: null, poly: null, points: [] };
        trucks[id] = t;

        const lat = Number(item.lat);
        const lng = Number(item.lng);

        ensureMarker(t, lat, lng);

        // Si estamos en turno, dibujamos/extendemos l√≠nea amarilla
        if (nowShift) {
          // Si GPSEyes trae "tail" (historial corto), lo usamos para ‚Äúarrancar bonito‚Äù
          if (Array.isArray(item.tail) && item.tail.length && t.points.length < 2) {
            // tail a veces llega como [[lat,lng], ...] o como objetos
            const pts = item.tail.map(p => Array.isArray(p) ? [Number(p[0]), Number(p[1])] : [Number(p.lat), Number(p.lng)]);
            t.points = pts;
            // Aseguramos el punto actual al final
            addPointAndDraw(t, lat, lng);
          } else {
            addPointAndDraw(t, lat, lng);
          }
        }
      }
    } catch (e) {
      console.error("Error live:", e);
      // No rompemos la UI
    }
  }

  // Arranque autom√°tico "En vivo"
  fetchLive();
  setInterval(fetchLive, POLL_MS);

  // ==========================
  // 5) CHATBOT (TU MISMO C√ìDIGO)
  // ==========================
  const botBtn = document.getElementById("chatbot-button");
  const botWindow = document.getElementById("chatbot-window");
  const messages = document.getElementById("chatbot-messages");
  const input = document.getElementById("user-input");
  const sendBtn = document.getElementById("send-btn");

  let step = 0;
  let dataForm = { name: "", direccion: "", incidencia: "" };

  function botSay(text) {
    const div = document.createElement("div");
    div.className = "msg bot";
    div.innerHTML = text;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
  }

  function userSay(text) {
    const div = document.createElement("div");
    div.className = "msg user";
    div.innerHTML = text;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
  }

  botBtn.onclick = () => {
    botWindow.style.display = botWindow.style.display === "flex" ? "none" : "flex";
    if (messages.innerHTML.trim() === "") startChat();
  };

  function startChat() {
    step = 0;
    botSay("üëã Hola vecino, gracias por apoyar el monitoreo ciudadano.");
    setTimeout(() => botSay("¬øCu√°l es tu nombre?"), 600);
  }

  sendBtn.onclick = () => processUserMessage();
  input.addEventListener("keypress", (e) => { if (e.key === "Enter") processUserMessage(); });

  function processUserMessage() {
    const text = input.value.trim();
    if (!text) return;
    userSay(text);
    input.value = "";

    if (step === 0) {
      dataForm.name = text;
      step = 1;
      setTimeout(() => botSay("¬øEn qu√© direcci√≥n ocurre el problema?"), 500);
    } else if (step === 1) {
      dataForm.direccion = text;
      step = 2;
      setTimeout(() => botSay("Por favor describe la incidencia."), 500);
    } else if (step === 2) {
      dataForm.incidencia = text;
      step = 3;
      sendReport();
    }
  }

  function sendReport() {
    botSay("‚è≥ Enviando reporte, por favor espera...");

    const msg = "Direcci√≥n: " + dataForm.direccion + "\n" + "Incidencia: " + dataForm.incidencia;

    emailjs.send("service_6n1vp4m", "template_7yj72fo", {
      name: dataForm.name,
      time: new Date().toLocaleString(),
      message: msg
    })
    .then(() => botSay("‚úîÔ∏è ¬°Tu reporte fue enviado por correo!"))
    .catch(() => botSay("‚ùå Hubo un problema al enviar el correo."));
  }
</script>

</body>
</html>
