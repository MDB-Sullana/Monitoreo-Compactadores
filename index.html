<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Monitoreo Ciudadano - Bellavista</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- EmailJS v4 -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script>
    emailjs.init({ publicKey: "IGGKWnrPTdwnN39yS" });
  </script>

  <style>
    body { font-family: 'Inter', sans-serif; background: #f3f4f6; }

    /* BOT√ìN FLOTANTE */
    #chatbot-button{
      position:fixed; bottom:25px; right:25px; background:#1e3a8a; color:#fff;
      width:65px; height:65px; border-radius:50%; display:flex; align-items:center;
      justify-content:center; font-size:28px; cursor:pointer; box-shadow:0 6px 15px rgba(0,0,0,.3);
      z-index:9999;
    }

    /* VENTANA CHAT */
    #chatbot-window{
      width:330px; height:480px; background:#fff; position:fixed; bottom:100px; right:25px;
      border-radius:15px; box-shadow:0 0 20px rgba(0,0,0,.25); display:none; flex-direction:column;
      overflow:hidden; z-index:9999;
    }
    #chatbot-messages{ flex:1; padding:10px; overflow-y:auto; background:#e5e7eb; }
    .msg{ margin-bottom:10px; padding:10px 14px; max-width:80%; border-radius:12px; font-size:14px; line-height:1.3; }
    .bot{ background:#fff; color:#000; }
    .user{ background:#1e3a8a; color:#fff; margin-left:auto; }
    #chat-input-box{ display:flex; padding:8px; border-top:1px solid #ddd; background:#fff; }
    #user-input{ flex:1; padding:8px; border:1px solid #ccc; border-radius:8px; }
    #send-btn{ margin-left:6px; background:#1e3a8a; color:#fff; padding:8px 14px; border-radius:8px; cursor:pointer; }

    /* ANIMACIONES */
    @keyframes fadeIn{ 0%{opacity:0; transform:scale(.95)} 100%{opacity:1; transform:scale(1)} }
    @keyframes slideUp{ 0%{opacity:0; transform:translateY(25px)} 100%{opacity:1; transform:translateY(0)} }
    @keyframes pulse{ 0%,100%{transform:scale(1); filter:brightness(1)} 50%{transform:scale(1.06); filter:brightness(1.15)} }
    @keyframes slide{ 0%{transform:translateX(-30px); opacity:.3} 50%{transform:translateX(30px); opacity:1} 100%{transform:translateX(-30px); opacity:.3} }
    @keyframes glow{ 0%{box-shadow:0 0 0 0 rgba(255,255,255,0)} 50%{box-shadow:0 0 20px 5px rgba(255,255,255,.35)} 100%{box-shadow:0 0 0 0 rgba(255,255,255,0)} }

    /* MAPA */
    #leaflet-map, #leaflet-map-cochera{
      width:100%;
      height:80vh;
      border-radius: 0.75rem;
    }
    .map-card{
      border-radius: 0.75rem;
      overflow:hidden;
    }

    /* Etiqueta estado */
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border-radius:999px;
      font-weight:700; font-size:12px;
      background:#0f172a; color:white;
      box-shadow:0 10px 25px rgba(0,0,0,.15);
    }
    .dot{ width:10px; height:10px; border-radius:999px; background:#22c55e; box-shadow:0 0 0 6px rgba(34,197,94,.15); }
    .dot-off{ background:#f59e0b; box-shadow:0 0 0 6px rgba(245,158,11,.15); }
  </style>
</head>

<body>

<!-- HEADER -->
<header class="relative shadow-xl py-3 px-4 flex items-center justify-center">
  <div class="absolute inset-0 bg-gradient-to-r from-blue-900 via-blue-800 to-blue-900 opacity-95"></div>

  <div class="relative z-10 flex items-center gap-4 select-none">
    <div class="relative">
      <img
        src="./logo-bellavista.jpeg"
        onerror="this.src='https://placehold.co/100x100/1e3a8a/ffffff?text=LOGO'"
        class="h-14 w-14 md:h-16 md:w-16 rounded-full object-cover shadow-xl ring-2 ring-white/40 animate-[pulse_4s_ease-in-out_infinite]"
      >
      <div class="absolute inset-0 rounded-full animate-[glow_3s_infinite]"></div>
    </div>

    <div class="flex flex-col justify-center text-white">
      <span class="text-xs md:text-sm uppercase tracking-wide text-blue-200 font-semibold">
        Municipalidad Distrital de Bellavista
      </span>
      <h1 class="text-lg md:text-2xl font-extrabold leading-tight drop-shadow-lg">
        Monitoreo Ciudadano de Camiones Compactadores
      </h1>
      <div class="mt-1 h-1 w-24 bg-gradient-to-r from-blue-300 to-white rounded-full"></div>
    </div>
  </div>
</header>

<main class="p-4 space-y-4">

  <!-- SECCI√ìN MAPA (EN VIVO) -->
  <div id="map-section" class="hidden space-y-3">
    <div class="flex items-center justify-between flex-wrap gap-2">
      <div class="badge">
        <span id="live-dot" class="dot"></span>
        <span id="live-text">EN VIVO (auto)</span>
      </div>

      <div class="text-xs text-slate-600 font-semibold">
        L√≠nea amarilla se dibuja: <span class="text-slate-900">07:00‚Äì12:30</span> y <span class="text-slate-900">14:00‚Äì22:00</span>
      </div>
    </div>

    <div class="map-card shadow-xl">
      <div id="leaflet-map"></div>
    </div>
  </div>

  <!-- SECCI√ìN COCHERA (MUESTRA CAMIONES IGUAL) -->
  <div id="cochera-section" class="hidden space-y-4">

    <div class="relative w-full flex items-center justify-center p-6">
      <div class="absolute inset-0 bg-gradient-to-br from-blue-900 via-blue-800 to-blue-700 opacity-95 rounded-3xl shadow-2xl"></div>

      <div class="relative z-10 backdrop-blur-xl bg-white/10 border border-white/20 rounded-3xl shadow-2xl
                  p-8 md:p-12 max-w-5xl w-full flex flex-col md:flex-row items-center gap-10 animate-[fadeIn_1s_ease-out]">

        <div class="flex flex-col items-center">
          <img
            src="./logo-bellavista.jpeg"
            onerror="this.src='https://placehold.co/200x200/1e3a8a/ffffff?text=LOGO';"
            class="w-40 h-40 md:w-48 md:h-48 rounded-full shadow-xl object-cover animate-[pulse_3s_infinite] ring-4 ring-white/40"
          >
          <div class="mt-3 w-24 h-1 bg-gradient-to-r from-blue-300 to-white rounded-full animate-[slide_2s_infinite]"></div>
        </div>

        <div class="text-center md:text-left animate-[slideUp_1s_ease-out]">
          <h2 class="text-3xl md:text-4xl font-extrabold mb-4 leading-tight text-white drop-shadow-lg">
            LOS CAMIONES EST√ÅN EN COCHERA
            <span class="block text-blue-200">MONITOREO PAUSADO FUERA DE HORARIO</span>
          </h2>

          <p class="text-lg md:text-xl mb-3 text-blue-100 font-medium">
            Igual podr√°s ver la ubicaci√≥n actual de las unidades en el mapa.
          </p>

          <p class="mt-6 text-xs md:text-sm text-blue-300 font-light">
            L√≠nea amarilla se dibuja: 07:00‚Äì12:30 y 14:00‚Äì22:00.
          </p>
        </div>
      </div>
    </div>

    <div class="flex items-center justify-between flex-wrap gap-2">
      <div class="badge">
        <span class="dot dot-off"></span>
        <span>FUERA DE HORARIO (pero mostrando unidades)</span>
      </div>
      <div class="text-xs text-slate-600 font-semibold">
        Se muestra ubicaci√≥n; la l√≠nea amarilla no se extiende fuera del horario.
      </div>
    </div>

    <div class="map-card shadow-xl">
      <div id="leaflet-map-cochera"></div>
    </div>

  </div>
</main>

<!-- BOT√ìN FLOTANTE -->
<div id="chatbot-button">üí¨</div>

<!-- CHATBOT -->
<div id="chatbot-window">
  <div id="chatbot-messages"></div>
  <div id="chat-input-box">
    <input type="text" id="user-input" placeholder="Escribe aqu√≠...">
    <button id="send-btn">Enviar</button>
  </div>
</div>

<script>
  // =========================
  //  CONFIG PRINCIPAL
  // =========================
  const WORKER_URL = "https://gps-bellavista.karolmauricio12.workers.dev/";
  const POLL_MS = 5000;

  // Tu horario para dibujar la l√≠nea amarilla:
  // 07:00‚Äì12:30 y 14:00‚Äì22:00
  function isWithinDrawWindow(d = new Date()) {
    const h = d.getHours();
    const m = d.getMinutes();
    const minutes = h * 60 + m;

    const morningStart = 7 * 60;         // 07:00
    const morningEnd   = 12 * 60 + 30;   // 12:30
    const eveStart     = 14 * 60;        // 14:00
    const eveEnd       = 22 * 60;        // 22:00

    return (minutes >= morningStart && minutes <= morningEnd) ||
           (minutes >= eveStart && minutes <= eveEnd);
  }

  // Tu l√≥gica de mostrar mapa vs cochera (la dejamos, pero mejorada)
  // Aqu√≠ decidimos qu√© secci√≥n mostrar; en ambos casos hay mapa.
  function shouldShowLiveSection(d = new Date()) {
    // Si quieres que el ‚Äúmap-section‚Äù se muestre SOLO dentro de la ventana de dibujo:
    // return isWithinDrawWindow(d);

    // Si quieres que el map-section se muestre desde 5:00 hasta 22:00 (como ven√≠as haciendo):
    const h = d.getHours();
    return (h >= 5 && h < 23:59);
  }

  // =========================
  //  ESTADO MAPA (2 mapas: live y cochera)
  // =========================
  const state = {
    live: null,
    cochera: null,
    lastFetchOk: false,
    lastSeen: {
      305: null, // COMPACTADOR
      809: null  // COMPACTADOR 2
    }
  };

  function makeBaseLayers() {
    const osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19, attribution: "&copy; OpenStreetMap"
    });

    const cartoLight = L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png", {
      maxZoom: 19, attribution: "&copy; CARTO"
    });

    const esriSat = L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}", {
      maxZoom: 19, attribution: "Tiles &copy; Esri"
    });

    return { osm, cartoLight, esriSat };
  }

  function initOneMap(containerId) {
    const { osm, cartoLight, esriSat } = makeBaseLayers();

    const map = L.map(containerId, {
      center: [-4.885, -80.678],
      zoom: 14,
      layers: [cartoLight] // default bonito
    });

    const baseLayers = {
      "Carto (claro)": cartoLight,
      "OpenStreetMap": osm,
      "Sat√©lite (ESRI)": esriSat
    };

    L.control.layers(baseLayers, null, { collapsed: true }).addTo(map);

    const trucks = {
      305: { name: "COMPACTADOR", marker: null, poly: L.polyline([], { color: "#FFD400", weight: 5, opacity: 0.9 }).addTo(map) },
      809: { name: "COMPACTADOR 2", marker: null, poly: L.polyline([], { color: "#FFD400", weight: 5, opacity: 0.9 }).addTo(map) }
    };

    return { map, trucks };
  }

  function ensureMaps() {
    if (!state.live) state.live = initOneMap("leaflet-map");
    if (!state.cochera) state.cochera = initOneMap("leaflet-map-cochera");
  }

  function setLiveBadge(isOk, isDrawing) {
    const dot = document.getElementById("live-dot");
    const txt = document.getElementById("live-text");
    if (!dot || !txt) return;

    if (!isOk) {
      dot.className = "dot dot-off";
      txt.textContent = "SIN CONEXI√ìN (reintentando)";
      return;
    }

    dot.className = isDrawing ? "dot" : "dot dot-off";
    txt.textContent = isDrawing ? "EN VIVO (dibujando ruta)" : "EN VIVO (ubicaci√≥n, ruta pausada)";
  }

  function upsertTruckOn(mapObj, item, canDraw) {
    if (!item || typeof item.lat === "undefined" || typeof item.lng === "undefined") return;

    const id = Number(item.id);
    const t = mapObj.trucks[id];
    if (!t) return;

    const lat = Number(item.lat);
    const lng = Number(item.lng);

    // Marker (icon simple)
    if (!t.marker) {
      t.marker = L.marker([lat, lng]).addTo(mapObj.map).bindPopup(`<b>${t.name}</b><br>Velocidad: ${item.speed ?? 0}`);
    } else {
      t.marker.setLatLng([lat, lng]);
    }

    // Dibujar l√≠nea: solo si estamos en ventana permitida
    if (canDraw) {
      const pts = t.poly.getLatLngs();
      const last = pts.length ? pts[pts.length - 1] : null;

      // Evitar duplicados muy pegados
      if (!last || Math.abs(last.lat - lat) > 0.00001 || Math.abs(last.lng - lng) > 0.00001) {
        pts.push([lat, lng]);
        t.poly.setLatLngs(pts);
      }
    }

    // Si el item trae "tail" y la polyline est√° vac√≠a, inicial√≠zala (bonito al entrar)
    // (tail viene como array de [lat,lng] en algunos casos)
    const currentPts = t.poly.getLatLngs();
    if (currentPts.length === 0 && Array.isArray(item.tail) && item.tail.length) {
      // tail puede venir como [[lat,lng], ...]
      if (Array.isArray(item.tail[0])) {
        t.poly.setLatLngs(item.tail.map(p => [Number(p[0]), Number(p[1])]));
      } else if (typeof item.tail[0] === "object") {
        // tail puede venir como [{lat,lng}, ...]
        t.poly.setLatLngs(item.tail.map(p => [Number(p.lat), Number(p.lng)]));
      }
    }
  }

  function fitOnceIfNeeded(mapObj, items) {
    // Al inicio, centra el mapa a los camiones si hay datos
    const boundsPts = [];
    for (const it of items) {
      if (it && it.lat != null && it.lng != null) boundsPts.push([Number(it.lat), Number(it.lng)]);
    }
    if (!boundsPts.length) return;

    // Solo una vez por mapa (cuando no ha sido movido todav√≠a)
    if (!mapObj._didFit) {
      mapObj._didFit = true;
      const b = L.latLngBounds(boundsPts);
      mapObj.map.fitBounds(b.pad(0.25));
    }
  }

  async function fetchPositions() {
    try {
      const r = await fetch(WORKER_URL, { cache: "no-store" });
      const data = await r.json();

      // Esperamos { ok:true, camion1:..., camion2:..., items_count:... }
      if (!data || data.ok !== true) {
        state.lastFetchOk = false;
        return null;
      }
      state.lastFetchOk = true;
      return data;
    } catch (e) {
      state.lastFetchOk = false;
      return null;
    }
  }

  async function tick() {
    ensureMaps();

    const now = new Date();
    const canDraw = isWithinDrawWindow(now);

    setLiveBadge(true, canDraw);

    const payload = await fetchPositions();
    if (!payload) {
      setLiveBadge(false, false);
      return;
    }

    const camion1 = payload.camion1 || null; // id 305
    const camion2 = payload.camion2 || null; // id 809

    const items = [];
    if (camion1) items.push(camion1);
    if (camion2) items.push(camion2);

    // Si alg√∫n cami√≥n viene null, igual mantenemos el √∫ltimo conocido (para que no "desaparezca")
    if (!camion1 && state.lastSeen[305]) items.push(state.lastSeen[305]);
    if (!camion2 && state.lastSeen[809]) items.push(state.lastSeen[809]);

    // actualiza cache last seen
    if (camion1) state.lastSeen[305] = camion1;
    if (camion2) state.lastSeen[809] = camion2;

    // Pinta en ambos mapas
    for (const it of items) {
      upsertTruckOn(state.live, it, canDraw);
      upsertTruckOn(state.cochera, it, canDraw);
    }

    fitOnceIfNeeded(state.live, items);
    fitOnceIfNeeded(state.cochera, items);
  }

  // =========================
  //  MOSTRAR SECCIONES (map/cochera)
  // =========================
  function configurarVista() {
    const now = new Date();
    const mapSection = document.getElementById("map-section");
    const cocheraSection = document.getElementById("cochera-section");

    if (shouldShowLiveSection(now)) {
      mapSection.classList.remove("hidden");
      cocheraSection.classList.add("hidden");
    } else {
      cocheraSection.classList.remove("hidden");
      mapSection.classList.add("hidden");
    }
  }

  // Inicia todo
  window.addEventListener("load", () => {
    configurarVista();

    // Auto ‚ÄúEn vivo‚Äù
    tick();
    setInterval(tick, POLL_MS);

    // Actualiza vista por horario cada minuto
    setInterval(configurarVista, 60 * 1000);
  });

  // =========================
  //  CHATBOT (tu c√≥digo tal cual)
  // =========================
  const botBtn = document.getElementById("chatbot-button");
  const botWindow = document.getElementById("chatbot-window");
  const messages = document.getElementById("chatbot-messages");
  const input = document.getElementById("user-input");
  const sendBtn = document.getElementById("send-btn");

  let step = 0;
  let data = { name: "", direccion: "", incidencia: "" };

  function botSay(text) {
    const div = document.createElement("div");
    div.className = "msg bot";
    div.innerHTML = text;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
  }

  function userSay(text) {
    const div = document.createElement("div");
    div.className = "msg user";
    div.innerHTML = text;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
  }

  botBtn.onclick = () => {
    botWindow.style.display = botWindow.style.display === "flex" ? "none" : "flex";
    if (messages.innerHTML.trim() === "") startChat();
  };

  function startChat() {
    step = 0;
    botSay("üëã Hola vecino, gracias por apoyar el monitoreo ciudadano.");
    setTimeout(() => botSay("¬øCu√°l es tu nombre?"), 600);
  }

  sendBtn.onclick = () => processUserMessage();
  input.addEventListener("keypress", (e) => {
    if (e.key === "Enter") processUserMessage();
  });

  function processUserMessage() {
    const text = input.value.trim();
    if (!text) return;
    userSay(text);
    input.value = "";

    if (step === 0) {
      data.name = text;
      step = 1;
      setTimeout(() => botSay("¬øEn qu√© direcci√≥n ocurre el problema?"), 500);
    }
    else if (step === 1) {
      data.direccion = text;
      step = 2;
      setTimeout(() => botSay("Por favor describe la incidencia."), 500);
    }
    else if (step === 2) {
      data.incidencia = text;
      step = 3;
      sendReport();
    }
  }

  function sendReport() {
    botSay("‚è≥ Enviando reporte, por favor espera...");

    const msg = "Direcci√≥n: " + data.direccion + "\n" + "Incidencia: " + data.incidencia;

    emailjs.send("service_6n1vp4m", "template_7yj72fo", {
      name: data.name,
      time: new Date().toLocaleString(),
      message: msg
    })
    .then(() => botSay("‚úîÔ∏è ¬°Tu reporte fue enviado por correo!"))
    .catch(() => botSay("‚ùå Hubo un problema al enviar el correo."));
  }
</script>

</body>
</html>
