<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Monitoreo Ciudadano - Bellavista</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- EmailJS v4 -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script>
    emailjs.init({ publicKey: "IGGKWnrPTdwnN39yS" });
  </script>

  <!-- Google Maps JS API -->
  <script async
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyACZqyFcGlVIhuXsKPgdmWZFXeoRHs8glk&v=weekly">
  </script>

  <style>
    body { font-family: 'Inter', sans-serif; background: #f3f4f6; }

    /* BOT√ìN FLOTANTE */
    #chatbot-button{
      position: fixed; bottom: 25px; right: 25px;
      background: #1e3a8a; color: #fff;
      width: 65px; height: 65px; border-radius: 50%;
      display:flex; align-items:center; justify-content:center;
      font-size: 28px; cursor:pointer;
      box-shadow: 0 6px 15px rgba(0,0,0,0.3);
      z-index: 9999;
    }

    /* VENTANA DEL CHAT */
    #chatbot-window{
      width: 330px; height: 480px; background: #fff;
      position: fixed; bottom: 100px; right: 25px;
      border-radius: 15px;
      box-shadow: 0 0 20px rgba(0,0,0,0.25);
      display: none; flex-direction: column; overflow: hidden;
      z-index: 9999;
    }

    #chatbot-messages{
      flex: 1; padding: 10px; overflow-y: auto; background:#e5e7eb;
    }

    .msg{
      margin-bottom: 10px; padding: 10px 14px; max-width: 80%;
      border-radius: 12px; font-size: 14px; line-height: 1.3;
    }
    .bot{ background: white; color: black; }
    .user{ background: #1e3a8a; color: white; margin-left:auto; }

    #chat-input-box{
      display:flex; padding: 8px; border-top: 1px solid #ddd; background: #fff;
    }
    #user-input{
      flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 8px;
    }
    #send-btn{
      margin-left: 6px; background: #1e3a8a; color:#fff;
      padding: 8px 14px; border-radius: 8px; cursor:pointer;
    }

    /* Map container */
    #map {
      width: 100%;
      height: 80vh;
      border-radius: 16px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
      overflow: hidden;
      background: #dbeafe;
    }

    /* Top controls */
    .map-toolbar{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      margin-bottom: 12px;
    }
    .btn{
      background:#1e3a8a; color:#fff; padding:10px 14px; border-radius:10px;
      font-weight:700; cursor:pointer; box-shadow: 0 6px 12px rgba(0,0,0,0.12);
      user-select:none;
    }
    .btn.secondary{ background:#0f172a; }
    .badge{
      background:#fff; border:1px solid #e5e7eb; padding:10px 12px; border-radius:10px;
      font-weight:700;
    }

    /* Name label above icon */
    .truck-label{
      background: rgba(15,23,42,0.9);
      color: #fff;
      padding: 4px 8px;
      border-radius: 10px;
      font-weight: 800;
      font-size: 12px;
      white-space: nowrap;
      transform: translate(-50%, -120%);
      position: absolute;
      left: 50%;
      top: 0;
      box-shadow: 0 6px 12px rgba(0,0,0,0.25);
    }
    .truck-wrap{
      position: relative;
      transform: translate(-50%, -100%);
      pointer-events: auto;
    }
    .truck-img{
      width: 44px;
      height: 44px;
      object-fit: contain;
      filter: drop-shadow(0 6px 10px rgba(0,0,0,0.35));
    }
  </style>
</head>

<body>

<header class="relative shadow-xl py-3 px-4 flex items-center justify-center">
  <div class="absolute inset-0 bg-gradient-to-r from-blue-900 via-blue-800 to-blue-900 opacity-95"></div>
  <div class="relative z-10 flex items-center gap-4 select-none">
    <div class="relative">
      <img
        src="./logo-bellavista.jpeg"
        onerror="this.src='https://placehold.co/100x100/1e3a8a/ffffff?text=LOGO'"
        class="h-14 w-14 md:h-16 md:w-16 rounded-full object-cover shadow-xl ring-2 ring-white/40">
    </div>

    <div class="flex flex-col justify-center text-white">
      <span class="text-xs md:text-sm uppercase tracking-wide text-blue-200 font-semibold">
        Municipalidad Distrital de Bellavista
      </span>

      <h1 class="text-lg md:text-2xl font-extrabold leading-tight drop-shadow-lg">
        Monitoreo Ciudadano de Camiones Compactadores
      </h1>

      <div class="mt-1 h-1 w-24 bg-gradient-to-r from-blue-300 to-white rounded-full"></div>
    </div>
  </div>
</header>

<main class="p-4">

  <div class="map-toolbar">
    <div class="badge">üü° Ruta en vivo + Camiones siempre visibles</div>
    <div class="btn" id="btn-live">En vivo (Auto)</div>
    <div class="btn secondary" id="btn-center">Centrar</div>
    <div class="badge" id="status-text">Estado: esperando Google Maps‚Ä¶</div>
  </div>

  <div id="map"></div>

</main>

<div id="chatbot-button">üí¨</div>

<div id="chatbot-window">
  <div id="chatbot-messages"></div>
  <div id="chat-input-box">
    <input type="text" id="user-input" placeholder="Escribe aqu√≠...">
    <button id="send-btn">Enviar</button>
  </div>
</div>

<script>
/* =========================
   CONFIG
========================= */
const WORKER_URL = "https://gps-bellavista.karolmauricio12.workers.dev/";

// IDs compactadores
const DEVICE_IDS = [305, 809];

// polling
const POLL_MS = 8000;

// Iconos locales
const ICONS = {
  305: "./Compactador.jpeg",
  809: "./Compactador2.jpeg"
};

// Horarios de ‚Äúdibujar l√≠nea amarilla‚Äù
function dentroDeHorarioRuta() {
  const now = new Date();
  const minutes = now.getHours() * 60 + now.getMinutes();

  const m1Start = 7 * 60;        // 07:00
  const m1End   = 12 * 60 + 30;  // 12:30
  const t1Start = 14 * 60;       // 14:00
  const t1End   = 22 * 60;       // 22:00

  return (minutes >= m1Start && minutes <= m1End) || (minutes >= t1Start && minutes <= t1End);
}

function toNum(v) {
  const n = (typeof v === "number") ? v : parseFloat(v);
  return Number.isFinite(n) ? n : null;
}

/* =========================
   GOOGLE MAP + OVERLAY ICONS
========================= */
let map;
let liveTimer = null;

const polylines = new Map();   // id -> google.maps.Polyline

class HtmlMarker extends google.maps.OverlayView {
  constructor(position, map, id, name, iconUrl) {
    super();
    this.position = position;
    this.id = id;
    this.name = name;
    this.iconUrl = iconUrl;
    this.div = null;
    this.setMap(map);
  }

  onAdd() {
    const div = document.createElement("div");
    div.className = "truck-wrap";

    const label = document.createElement("div");
    label.className = "truck-label";
    label.textContent = this.name;

    const img = document.createElement("img");
    img.className = "truck-img";
    img.src = this.iconUrl;
    img.onerror = () => {
      img.src = "https://maps.gstatic.com/mapfiles/api-3/images/spotlight-poi2_hdpi.png";
    };

    div.appendChild(label);
    div.appendChild(img);

    this.div = div;
    this.getPanes().overlayMouseTarget.appendChild(div);
  }

  draw() {
    const projection = this.getProjection();
    if (!projection || !this.div) return;

    const point = projection.fromLatLngToDivPixel(this.position);
    this.div.style.position = "absolute";
    this.div.style.left = point.x + "px";
    this.div.style.top = point.y + "px";
  }

  onRemove() {
    if (this.div) this.div.remove();
    this.div = null;
  }

  setPosition(latLng) {
    this.position = latLng;
    this.draw();
  }

  setName(name) {
    this.name = name;
    if (this.div) {
      const label = this.div.querySelector(".truck-label");
      if (label) label.textContent = name;
    }
  }
}

const htmlMarkers = new Map(); // id -> HtmlMarker

function initMap() {
  const center = { lat: -4.8848, lng: -80.6781 };

  map = new google.maps.Map(document.getElementById("map"), {
    center,
    zoom: 15,
    mapTypeId: "hybrid",
    streetViewControl: false,
    mapTypeControl: true,
    fullscreenControl: true,
    gestureHandling: "greedy"
  });

  setStatus("mapa listo ‚úÖ");
  startLive();

  document.getElementById("btn-live").addEventListener("click", () => {
    if (liveTimer) stopLive();
    else startLive();
  });

  document.getElementById("btn-center").addEventListener("click", () => {
    map.setCenter(center);
    map.setZoom(15);
  });
}

function stopLive() {
  clearInterval(liveTimer);
  liveTimer = null;
  document.getElementById("btn-live").textContent = "En vivo (OFF)";
  setStatus("en vivo detenido ‚è∏Ô∏è");
}

function startLive() {
  document.getElementById("btn-live").textContent = "En vivo (ON)";
  setStatus("cargando camiones‚Ä¶");
  tick();
  liveTimer = setInterval(tick, POLL_MS);
}

/* =========================
   FETCH + DIBUJO
========================= */
async function fetchWorker(url) {
  const r = await fetch(url, { cache: "no-store" });
  return await r.json();
}

// modo recomendado: 1 llamada general (m√°s estable que 2 llamadas device_id)
async function fetchAllTrucks() {
  const url = WORKER_URL + "?_=" + Date.now();
  return await fetchWorker(url);
}

// fallback: por si quieres forzar device_id
async function fetchDevice(id) {
  const url = WORKER_URL + "?device_id=" + encodeURIComponent(id) + "&_=" + Date.now();
  return await fetchWorker(url);
}

function ensurePolyline(id) {
  if (polylines.has(id)) return polylines.get(id);

  const pl = new google.maps.Polyline({
    path: [],
    geodesic: true,
    strokeOpacity: 0.95,
    strokeWeight: 5,
    strokeColor: "#FFD400"
  });
  pl.setMap(map);
  polylines.set(id, pl);
  return pl;
}

function updateTruck(id, item) {
  const lat = toNum(item.lat);
  const lng = toNum(item.lng);

  if (!Number.isFinite(lat) || !Number.isFinite(lng)) {
    return false;
  }

  const pos = new google.maps.LatLng(lat, lng);

  // HTML marker
  if (!htmlMarkers.has(id)) {
    const hm = new HtmlMarker(pos, map, id, item.name || ("Cami√≥n " + id), ICONS[id] || ICONS[305]);
    htmlMarkers.set(id, hm);
  } else {
    const hm = htmlMarkers.get(id);
    hm.setPosition(pos);
    hm.setName(item.name || ("Cami√≥n " + id));
  }

  // Ruta amarilla en horario
  const habilitarLinea = dentroDeHorarioRuta();
  const pl = ensurePolyline(id);

  if (habilitarLinea && Array.isArray(item.tail) && item.tail.length) {
    const path = item.tail
      .map(p => ({ lat: toNum(p.lat), lng: toNum(p.lng) }))
      .filter(p => Number.isFinite(p.lat) && Number.isFinite(p.lng));

    if (path.length) {
      pl.setPath(path);
      pl.setOptions({ strokeColor: "#FFD400" });
      pl.setMap(map);
    }
  } else {
    pl.setMap(null);
  }

  return true;
}

function setStatus(text) {
  document.getElementById("status-text").textContent = "Estado: " + text;
}

async function tick() {
  try {
    // 1) Intento principal: una sola llamada general
    const res = await fetchAllTrucks();

    if (!res || res.ok !== true) {
      setStatus("worker no OK (cookie/endpoint) ‚ö†Ô∏è");
      return;
    }

    let updated = 0;

    // Soporta forma general: camion1/camion2
    const c1 = res.camion1 || null;
    const c2 = res.camion2 || null;

    if (c1 && updateTruck(Number(c1.id), c1)) updated++;
    if (c2 && updateTruck(Number(c2.id), c2)) updated++;

    // Si no vino camion1/camion2 pero s√≠ vino item (por alg√∫n motivo)
    if (updated === 0 && res.item) {
      if (updateTruck(Number(res.item.id), res.item)) updated++;
    }

    // 2) Fallback: si items_count=0 o no actualiz√≥ nada, probamos device_id
    if (updated === 0) {
      const [r305, r809] = await Promise.all([fetchDevice(305), fetchDevice(809)]);
      if (r305?.ok && r305.item && updateTruck(305, r305.item)) updated++;
      if (r809?.ok && r809.item && updateTruck(809, r809.item)) updated++;
    }

    if (updated > 0) {
      const horario = dentroDeHorarioRuta() ? " (ruta amarilla ON)" : " (ruta amarilla OFF por horario)";
      setStatus("camiones actualizados ‚úÖ" + horario);
    } else {
      setStatus("sin datos (items_count=0 o cookie) ‚ö†Ô∏è");
    }

  } catch (e) {
    console.error(e);
    setStatus("error al actualizar ‚ùå");
  }
}

/* Espera a que cargue Google Maps */
(function waitForMaps() {
  const t = setInterval(() => {
    if (window.google && google.maps && google.maps.Map) {
      clearInterval(t);
      initMap();
    }
  }, 120);
})();
</script>

<script>
/* =========================
   CHATBOT + EMAILJS (SIN TOCAR)
========================= */
const botBtn = document.getElementById("chatbot-button");
const botWindow = document.getElementById("chatbot-window");
const messages = document.getElementById("chatbot-messages");
const input = document.getElementById("user-input");
const sendBtn = document.getElementById("send-btn");

let step = 0;
let data = { name: "", direccion: "", incidencia: "" };

function botSay(text) {
  const div = document.createElement("div");
  div.className = "msg bot";
  div.innerHTML = text;
  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;
}

function userSay(text) {
  const div = document.createElement("div");
  div.className = "msg user";
  div.innerHTML = text;
  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;
}

botBtn.onclick = () => {
  botWindow.style.display = (botWindow.style.display === "flex") ? "none" : "flex";
  if (messages.innerHTML.trim() === "") startChat();
};

function startChat() {
  step = 0;
  botSay("üëã Hola vecino, gracias por apoyar el monitoreo ciudadano.");
  setTimeout(() => botSay("¬øCu√°l es tu nombre?"), 600);
}

sendBtn.onclick = () => processUserMessage();
input.addEventListener("keypress", (e) => {
  if (e.key === "Enter") processUserMessage();
});

function processUserMessage() {
  const text = input.value.trim();
  if (!text) return;
  userSay(text);
  input.value = "";

  if (step === 0) {
    data.name = text;
    step = 1;
    setTimeout(() => botSay("¬øEn qu√© direcci√≥n ocurre el problema?"), 500);
  }
  else if (step === 1) {
    data.direccion = text;
    step = 2;
    setTimeout(() => botSay("Por favor describe la incidencia."), 500);
  }
  else if (step === 2) {
    data.incidencia = text;
    step = 3;
    sendReport();
  }
}

function sendReport() {
  botSay("‚è≥ Enviando reporte, por favor espera...");

  const msg =
    "Direcci√≥n: " + data.direccion + "\n" +
    "Incidencia: " + data.incidencia;

  emailjs.send("service_6n1vp4m", "template_7yj72fo", {
    name: data.name,
    time: new Date().toLocaleString(),
    message: msg
  })
  .then(() => {
    botSay("‚úîÔ∏è ¬°Tu reporte fue enviado por correo!");
  })
  .catch(() => {
    botSay("‚ùå Hubo un problema al enviar el correo.");
  });
}
</script>

</body>
</html>

